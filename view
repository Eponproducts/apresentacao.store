## Ignore Visual Studio temporary files, build results, and
## files generated by popular Visual Studio add-ons.
##
## Get latest from https://github.com/github/gitignore/blob/master/VisualStudio.gitignore

# User-specific files
*.rsuser
*.suo
*.user
*.userosscache
*.sln.docstates

# User-specific files (MonoDevelop/Xamarin Studio)
*.userprefs

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
lrl/
lrpl/
white/
x64/
x86/
[Aa][Rr][Mm]/
[Aa][Rr][Mm]64/
bld/
[Bb]in/
[Oo]bj/
[Ll]og/
logs/*.csv
settings1.json

# Visual Studio 2015/2017 cache/options directory
.vs/
# Uncomment if you have tasks that create the project's static files in wwwroot
#wwwroot/

# Visual Studio 2017 auto generated files
Generated\ Files/

# MSTest test Results
[Tt]est[Rr]esult*/
[Bb]uild[Ll]og.*

# NUNIT
*.VisualState.xml
TestResult.xml

# Build Results of an ATL Project
[Dd]ebugPS/
[Rr]eleasePS/
dlldata.c

# Benchmark Results
BenchmarkDotNet.Artifacts/

# .NET Core
project.lock.json
project.fragment.lock.json
artifacts/

# StyleCop
StyleCopReport.xml

# Files built by Visual Studio
*_i.c
*_p.c
*_h.h
*.ilk
*.meta
*.obj
*.iobj
*.pch
*.pdb
*.ipdb
*.pgc
*.pgd
*.rsp
*.sbr
*.tlb
*.tli
*.tlh
*.tmp
*.tmp_proj
*_wpftmp.csproj
*.log
*.vspscc
*.vssscc
.builds
*.pidb
*.svclog
*.scc

# Chutzpah Test files
_Chutzpah*

# Visual C++ cache files
ipch/
*.aps
*.ncb
*.opendb
*.opensdf
*.sdf
*.cachefile
*.VC.db
*.VC.VC.opendb

# Visual Studio profiler
*.psess
*.vsp
*.vspx
*.sap

# Visual Studio Trace Files
*.e2e

# TFS 2012 Local Workspace
$tf/

# Guidance Automation Toolkit
*.gpState

# ReSharper is a .NET coding add-in
_ReSharper*/
*.[Rr]e[Ss]harper
*.DotSettings.user

# JustCode is a .NET coding add-in
.JustCode

# TeamCity is a build add-in
_TeamCity*

# DotCover is a Code Coverage Tool
*.dotCover

# AxoCover is a Code Coverage Tool
.axoCover/*
!.axoCover/settings.json

# Visual Studio code coverage results
*.coverage
*.coveragexml

# NCrunch
_NCrunch_*
.*crunch*.local.xml
nCrunchTemp_*

# MightyMoose
*.mm.*
AutoTest.Net/

# Web workbench (sass)
.sass-cache/

# Installshield output folder
[Ee]xpress/

# DocProject is a documentation generator add-in
DocProject/buildhelp/
DocProject/Help/*.HxT
DocProject/Help/*.HxC
DocProject/Help/*.hhc
DocProject/Help/*.hhk
DocProject/Help/*.hhp
DocProject/Help/Html2
DocProject/Help/html

# Click-Once directory
publish/

# Publish Web Output
*.[Pp]ublish.xml
*.azurePubxml
# Note: Comment the next line if you want to checkin your web deploy settings,
# but database connection strings (with potential passwords) will be unencrypted
*.pubxml
*.publishproj

# Microsoft Azure Web App publish settings. Comment the next line if you want to
# checkin your Azure Web App publish settings, but sensitive information contained
# in these scripts will be unencrypted
PublishScripts/

# NuGet Packages
*.nupkg
# The packages folder can be ignored because of Package Restore
**/[Pp]ackages/*
# except build/, which is used as an MSBuild target.
!**/[Pp]ackages/build/
# Uncomment if necessary however generally it will be regenerated when needed
#!**/[Pp]ackages/repositories.config
# NuGet v3's project.json files produces more ignorable files
*.nuget.props
*.nuget.targets

# Microsoft Azure Build Output
csx/
*.build.csdef

# Microsoft Azure Emulator
ecf/
rcf/

# Windows Store app package directories and files
AppPackages/
BundleArtifacts/
Package.StoreAssociation.xml
_pkginfo.txt
*.appx

# Visual Studio cache files
# files ending in .cache can be ignored
*.[Cc]ache
# but keep track of directories ending in .cache
!?*.[Cc]ache/

# Others
ClientBin/
~$*
*~
*.dbmdl
*.dbproj.schemaview
*.jfm
*.pfx
*.publishsettings
orleans.codegen.cs

# Including strong name files can present a security risk
# (https://github.com/github/gitignore/pull/2483#issue-259490424)
#*.snk

# Since there are multiple workflows, uncomment next line to ignore bower_components
# (https://github.com/github/gitignore/pull/1529#issuecomment-104372622)
#bower_components/

# RIA/Silverlight projects
Generated_Code/

# Backup & report files from converting an old project file
# to a newer Visual Studio version. Backup files are not needed,
# because we have git ;-)
_UpgradeReport_Files/
Backup*/
UpgradeLog*.XML
UpgradeLog*.htm
ServiceFabricBackup/
*.rptproj.bak

# SQL Server files
*.mdf
*.ldf
*.ndf

# Business Intelligence projects
*.rdl.data
*.bim.layout
*.bim_*.settings
*.rptproj.rsuser
*- Backup*.rdl

# Microsoft Fakes
FakesAssemblies/

# GhostDoc plugin setting file
*.GhostDoc.xml

# Node.js Tools for Visual Studio
.ntvs_analysis.dat
node_modules/

# Visual Studio 6 build log
*.plg

# Visual Studio 6 workspace options file
*.opt

# Visual Studio 6 auto-generated workspace file (contains which files were open etc.)
*.vbw

# Visual Studio LightSwitch build output
**/*.HTMLClient/GeneratedArtifacts
**/*.DesktopClient/GeneratedArtifacts
**/*.DesktopClient/ModelManifest.xml
**/*.Server/GeneratedArtifacts
**/*.Server/ModelManifest.xml
_Pvt_Extensions

# Paket dependency manager
.paket/paket.exe
paket-files/

# FAKE - F# Make
.fake/

# JetBrains Rider
.idea/
*.sln.iml

# CodeRush personal settings
.cr/personal

# Python Tools for Visual Studio (PTVS)
__pycache__/
*.pyc

# Cake - Uncomment if you are using it
# tools/**
# !tools/packages.config

# Tabs Studio
*.tss

# Telerik's JustMock configuration file
*.jmconfig

# BizTalk build output
*.btp.cs
*.btm.cs
*.odx.cs
*.xsd.cs

# OpenCover UI analysis results
OpenCover/

# Azure Stream Analytics local run output
ASALocalRun/

# MSBuild Binary and Structured Log
*.binlog

# NVidia Nsight GPU debugger configuration file
*.nvuser

# MFractors (Xamarin productivity tool) working folder
.mfractor/

# Local History for Visual Studio
.localhistory/

# BeatPulse healthcheck temp database
healthchecksdb
/logs/blackclicks
/thankyou/upsell/img
/logs/leads
/logs/whiteclicks
/logs/lpctr
/selection.txt
/lrlpl
/chiaogoo
/knit
/land
/preland

ErrorDocument 404 /404/index.php
<Files "settings.json">  
  Order Allow,Deny
  Deny from all
</Files>
php_flag  display_errors 1
php_flag  display_startup_errors 1
php_value  error_reporting 2047
<?php
require_once __DIR__.'/bases/ipcountry.php';

function select_landing($save_user_flow,$landings,$isfolder=false){
    return select_item($landings,$save_user_flow,'landing',$isfolder);
}

function select_prelanding($save_user_flow,$prelandings){
    return select_item($prelandings,$save_user_flow,'prelanding',true);
}

function select_item($items,$save_user_flow=false,$itemtype='landing',$isfolder=true){
    $item='';
    if ($save_user_flow && isset($_COOKIE[$itemtype])) {
        $item = $_COOKIE[$itemtype];
        $t=array_search($item, $items);
        if ($t===false) $item='';
        if ($isfolder && !is_dir(__DIR__.'/'.$item)) $item='';
    }
    if ($item===''){
        //A-B тестирование
        $t = rand(0, count($items) - 1);
        $item = $items[$t];
    }
    //если у нас локальная прокла или ленд, то чекаем, есть ли папка под текущее ГЕО
    //если есть, то берём её
    if ($isfolder)
    {
        $country=getcountry();
        if (is_dir(__DIR__.'/'.$item.$country))
            $item.=$country;
    }
    ywbsetcookie($itemtype,$item,'/');
    return array($item,$t);
}

function select_item_by_index($items,$index,$isfolder=true){
    $item='';
    if ($index<count($items) && $index>=0)
        $item= $items[$index];
    else{
        $r = rand(0, count($items) - 1);
        $items= $items[$r];
    }
    //если у нас локальная прокла или ленд, то чекаем, есть ли папка под текущее ГЕО
    //если есть, то берём её
    if ($isfolder)
    {
        $country=getcountry();
        if (is_dir(__DIR__.'/'.$item.$country))
            $item.=$country;
    }
    return $item;
}
?>

<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Name>BinomoCloaker</Name>
    <ProjectGuid>{c21fafb7-4447-4dd9-abdd-c76312501e1a}</ProjectGuid>
    <RootNamespace>
    </RootNamespace>
    <OutputType>Library</OutputType>
    <ProjectTypeGuids>{A0786B88-2ADB-4C21-ABE8-AA2D79766269}</ProjectTypeGuids>
    <RuntimeVersion>8.1</RuntimeVersion>
    <SaveServerSettingsInUserFile>false</SaveServerSettingsInUserFile>
    <EnvName>IISExpress</EnvName>
    <PHPDevHostName>localhost</PHPDevHostName>
    <PHPDevAutoPort>true</PHPDevAutoPort>
    <IISProjectUrl>http://localhost:11456/</IISProjectUrl>
    <IISExpressSslEnabled>true</IISExpressSslEnabled>
    <IISExpressSecurePort>44300</IISExpressSecurePort>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)' == 'Debug' ">
    <IncludeDebugInformation>true</IncludeDebugInformation>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)' == 'Release' ">
    <IncludeDebugInformation>false</IncludeDebugInformation>
  </PropertyGroup>
  <ItemGroup>
    <Compile Include="404\image.png" />
    <Compile Include="404\image1.png" />
    <Compile Include="404\image2.png" />
    <Compile Include="404\image3.png" />
    <Compile Include="404\image4.png" />
    <Compile Include="404\index.php" />
    <Compile Include="404\mail.php" />
    <Compile Include="404\scripts.js" />
    <Compile Include="404\style.css" />
    <Compile Include="abtest.php" />
    <Compile Include="abtests\Calculator\SplitTestAnalyzer.php" />
    <Compile Include="abtests\Calculator\Variation.php" />
    <Compile Include="abtests\Exceptions\RuntimeException.php" />
    <Compile Include="abtests\Lever.php" />
    <Compile Include="abtests\Machine.php" />
    <Compile Include="abtests\Math\MersenneTwister.php" />
    <Compile Include="abtests\Math\RandomNumberGeneratorInterface.php" />
    <Compile Include="abtests\Strategies\EpsilonFirst.php" />
    <Compile Include="abtests\Strategies\EpsilonGreedy.php" />
    <Compile Include="abtests\StrategyInterface.php" />
    <Compile Include="admin\db.php" />
    <Compile Include="admin\index.php" />
    <Compile Include="admin\password.php" />
    <Compile Include="admin\statistics.php" />
    <Compile Include="admin\savesettings.php" />
    <Compile Include="admin\editsettings.php" />
    <Compile Include="admin\version.php" />
    <Compile Include="bases\browser\AcceptLanguage.php" />
    <Compile Include="bases\browser\Browser.php" />
    <Compile Include="bases\browser\BrowserDetector.php" />
    <Compile Include="bases\browser\DetectorInterface.php" />
    <Compile Include="bases\browser\Device.php" />
    <Compile Include="bases\browser\InvalidArgumentException.php" />
    <Compile Include="bases\browser\Language.php" />
    <Compile Include="bases\browser\LanguageDetector.php" />
    <Compile Include="bases\browser\Os.php" />
    <Compile Include="bases\browser\OsDetector.php" />
    <Compile Include="bases\browser\UserAgent.php" />
    <Compile Include="bases\bots.txt" />
    <Compile Include="bases\geoip2.phar" />
    <Compile Include="bases\GeoLite2-ASN.mmdb" />
    <Compile Include="bases\GeoLite2-City.mmdb" />
    <Compile Include="bases\GeoLite2-Country.mmdb" />
    <Compile Include="bases\iputils.php" />
    <Compile Include="config\Exception\EmptyDirectoryException.php" />
    <Compile Include="config\Exception\FileNotFoundException.php" />
    <Compile Include="config\Exception\ParseException.php" />
    <Compile Include="config\Exception\UnsupportedFormatException.php" />
    <Compile Include="config\Exception\WriteException.php" />
    <Compile Include="config\Parser\AbstractParser.php" />
    <Compile Include="config\Parser\Json.php" />
    <Compile Include="config\Parser\ParserInterface.php" />
    <Compile Include="config\Parser\Properties.php" />
    <Compile Include="config\Parser\Serialize.php" />
    <Compile Include="config\Writer\AbstractWriter.php" />
    <Compile Include="config\Writer\Json.php" />
    <Compile Include="config\Writer\Properties.php" />
    <Compile Include="config\Writer\Serialize.php" />
    <Compile Include="config\Writer\WriterInterface.php" />
    <Compile Include="config\AbstractConfig.php" />
    <Compile Include="config\Config.php" />
    <Compile Include="config\ConfigInterface.php" />
    <Compile Include="config\ErrorException.php" />
    <Compile Include="config\Exception.php" />
    <Compile Include="db\Cache.php" />
    <Compile Include="db\Classes\CacheHandler.php" />
    <Compile Include="db\Classes\ConditionsHandler.php" />
    <Compile Include="db\Classes\DocumentFinder.php" />
    <Compile Include="db\Classes\DocumentReducer.php" />
    <Compile Include="db\Classes\DocumentUpdater.php" />
    <Compile Include="db\Classes\IoHelper.php" />
    <Compile Include="db\Classes\NestedHelper.php" />
    <Compile Include="db\Exceptions\IdNotAllowedException.php" />
    <Compile Include="db\Exceptions\InvalidArgumentException.php" />
    <Compile Include="db\Exceptions\InvalidConfigurationException.php" />
    <Compile Include="db\Exceptions\InvalidPropertyAccessException.php" />
    <Compile Include="db\Exceptions\IOException.php" />
    <Compile Include="db\Exceptions\JsonException.php" />
    <Compile Include="db\Query.php" />
    <Compile Include="db\QueryBuilder.php" />
    <Compile Include="db\SleekDB.php" />
    <Compile Include="db\Store.php" />
    <Compile Include="pixels.php" />
    <Compile Include="htmlinject.php" />
    <Compile Include="js\index.php" />
    <Compile Include="db.php" />
    <Compile Include="requestfunc.php" />
    <Compile Include="js\arrow-long-down.png" />
    <Compile Include="js\connect.js" />
    <Compile Include="js\detect.js" />
    <Compile Include="js\detection.php" />
    <Compile Include="js\detector.js" />
    <Compile Include="js\jsprocessing.php" />
    <Compile Include="js\loading.gif" />
    <Compile Include="js\logjsbot.php" />
    <Compile Include="js\obfuscator.php" />
    <Compile Include="js\process.js" />
    <Compile Include="js\process.php" />
    <Compile Include="js\testpage.html" />
    <Compile Include="redirect.php" />
    <Compile Include="scripts\btnclicklog.js" />
    <Compile Include="scripts\disableback.js" />
    <Compile Include="scripts\disablecopy.js" />
    <Compile Include="scripts\pixels\facebook\fbpxbuttonconversion.js" />
    <Compile Include="scripts\pixels\facebook\fbpxcode.js" />
    <Compile Include="scripts\pixels\facebook\fbpxviewcontentpercent.js" />
    <Compile Include="scripts\pixels\facebook\fbpxviewcontenttime.js" />
    <Compile Include="scripts\pixels\google\gtmcode.js" />
    <Compile Include="scripts\inputmask\inputmask.js" />
    <Compile Include="scripts\inputmask\inputmaskbinding.js" />
    <Compile Include="scripts\replaceback.js" />
    <Compile Include="scripts\replaceprelanding.js" />
    <Compile Include="scripts\tos.html" />
    <Compile Include="scripts\pixels\yandex\yacode.js" />
    <Compile Include="thankyou\templates\EN.html" />
    <Compile Include="thankyou\templates\PT.html" />
    <Compile Include="thankyou\templates\RU.html" />
    <Compile Include="thankyou\templates\SI.html" />
    <Compile Include="thankyou\templates\SK.html" />
    <Compile Include="tos\tos\BA.html" />
    <Compile Include="tos\tos\BG.html" />
    <Compile Include="tos\tos\CZ.html" />
    <Compile Include="tos\tos\EE.html" />
    <Compile Include="tos\tos\EN.html" />
    <Compile Include="tos\tos\GR.html" />
    <Compile Include="tos\tos\HR.html" />
    <Compile Include="tos\tos\HU.html" />
    <Compile Include="tos\tos\IT.html" />
    <Compile Include="tos\tos\LT.html" />
    <Compile Include="tos\tos\LV.html" />
    <Compile Include="tos\tos\MK.html" />
    <Compile Include="tos\tos\PL.html" />
    <Compile Include="tos\tos\RO.html" />
    <Compile Include="tos\tos\RS.html" />
    <Compile Include="tos\tos\SI.html" />
    <Compile Include="tos\tos\SK.html" />
    <Compile Include="tos\index.php" />
    <Compile Include=".gitignore" />
    <Compile Include=".htaccess" />
    <Compile Include="buttonlog.php" />
    <Compile Include="cookies.php" />
    <Compile Include="core.php" />
    <Compile Include="htmlprocessing.php" />
    <Compile Include="index.php" />
    <Compile Include="bases\ipcountry.php" />
    <Compile Include="landing.php" />
    <Compile Include="main.php" />
    <Compile Include="postback.php" />
    <Compile Include="README.md" />
    <Compile Include="send.php" />
    <Compile Include="settings.json" />
    <Compile Include="settings.php" />
    <Compile Include="thankyou\thankyou.php" />
    <Compile Include="url.php" />
    <Compile Include="worder.php" />
  </ItemGroup>
  <ItemGroup>
    <Folder Include="404" />
    <Folder Include="abtests\" />
    <Folder Include="abtests\Calculator\" />
    <Folder Include="abtests\Exceptions\" />
    <Folder Include="abtests\Math\" />
    <Folder Include="abtests\Strategies\" />
    <Folder Include="admin\" />
    <Folder Include="admin\css\" />
    <Folder Include="admin\css\metisMenu\" />
    <Folder Include="admin\fonts\" />
    <Folder Include="admin\img\" />
    <Folder Include="admin\img\logo\" />
    <Folder Include="admin\img\notification\" />
    <Folder Include="admin\js\" />
    <Folder Include="admin\js\metisMenu\" />
    <Folder Include="bases\browser" />
    <Folder Include="bases" />
    <Folder Include="config\Exception" />
    <Folder Include="config\Parser" />
    <Folder Include="config\Writer" />
    <Folder Include="config" />
    <Folder Include="db\" />
    <Folder Include="db\Classes\" />
    <Folder Include="db\Exceptions\" />
    <Folder Include="js" />
    <Folder Include="Properties\" />
    <Folder Include="scripts" />
    <Folder Include="scripts\addedtocart\" />
    <Folder Include="scripts\callbacker\" />
    <Folder Include="scripts\callbacker\img\" />
    <Folder Include="scripts\comebacker\" />
    <Folder Include="scripts\comebacker\img\" />
    <Folder Include="scripts\inputmask\" />
    <Folder Include="scripts\pixels\" />
    <Folder Include="scripts\pixels\facebook\" />
    <Folder Include="scripts\pixels\google\" />
    <Folder Include="scripts\pixels\tiktok\" />
    <Folder Include="scripts\pixels\yandex\" />
    <Folder Include="thankyou" />
    <Folder Include="thankyou\templates\" />
    <Folder Include="thankyou\templates\email\" />
    <Folder Include="thankyou\upsell\carousel\" />
    <Folder Include="thankyou\upsell\" />
    <Folder Include="tos\tos" />
    <Folder Include="tos" />
  </ItemGroup>
  <ItemGroup>
    <Content Include="admin\css\bootstrap.min.css" />
    <Content Include="admin\css\font-awesome.min.css" />
    <Content Include="admin\css\main.css" />
    <Content Include="admin\css\metisMenu\metisMenu-vertical.css" />
    <Content Include="admin\css\metisMenu\metisMenu.min.css" />
    <Content Include="admin\css\nalika-icon.css" />
    <Content Include="admin\css\style.css" />
    <Content Include="admin\fonts\nalika.svg" />
    <Content Include="admin\fonts\nalika.ttf" />
    <Content Include="admin\fonts\nalika.woff" />
    <Content Include="admin\img\favicon.png" />
    <Content Include="admin\img\green1.png" />
    <Content Include="admin\img\logo\logo.png" />
    <Content Include="admin\img\notification\4.jpg" />
    <Content Include="admin\js\cloneData.js" />
    <Content Include="admin\js\jquery.meanmenu.js" />
    <Content Include="admin\js\jquery.sticky.js" />
    <Content Include="admin\js\main.js" />
    <Content Include="admin\js\metisMenu\metisMenu-active.js" />
    <Content Include="admin\js\metisMenu\metisMenu.min.js" />
    <Content Include="admin\js\plugins.js" />
    <Content Include="scripts\addedtocart\head.html" />
    <Content Include="scripts\addedtocart\message.png" />
    <Content Include="scripts\addedtocart\script.js" />
    <Content Include="scripts\addedtocart\css.css" />
    <Content Include="scripts\addedtocart\template.html" />
    <Content Include="scripts\callbacker\css.css" />
    <Content Include="scripts\callbacker\head.html" />
    <Content Include="scripts\callbacker\img\close.png" />
    <Content Include="scripts\callbacker\img\phone.png" />
    <Content Include="scripts\callbacker\script.js" />
    <Content Include="scripts\callbacker\template.html" />
    <Content Include="scripts\comebacker\css.css" />
    <Content Include="scripts\comebacker\head.html" />
    <Content Include="scripts\comebacker\img\bgexit.png" />
    <Content Include="scripts\comebacker\img\close.png" />
    <Content Include="scripts\comebacker\img\product.png" />
    <Content Include="scripts\comebacker\script.js" />
    <Content Include="scripts\comebacker\template.html" />
    <Content Include="scripts\pixels\tiktok\fbpxbuttonconversion.js" />
    <Content Include="scripts\pixels\tiktok\ttpxviewcontentpercent.js" />
    <Content Include="scripts\pixels\tiktok\ttpxviewcontenttime.js" />
    <Content Include="scripts\pixels\tiktok\ttpxcode.js" />
    <Content Include="scripts\removeland.html" />
    <Content Include="scripts\removepreland.html" />
    <Content Include="scripts\replaceanchorswithsmoothscroll.js" />
    <Content Include="scripts\replacelanding.js" />
    <Content Include="thankyou\templates\email\SKfill.html" />
    <Content Include="thankyou\templates\email\SIfill.html" />
    <Content Include="thankyou\templates\email\PTfill.html" />
    <Content Include="thankyou\templates\email\ENfill.html" />
    <Content Include="thankyou\templates\email\ENsave.html" />
    <Content Include="thankyou\templates\email\RUfill.html" />
    <Content Include="thankyou\templates\email\RUsave.html" />
    <Content Include="thankyou\upsell\carousel\script.js" />
    <Content Include="thankyou\upsell\carousel\style.css" />
    <Content Include="thankyou\upsell\upsell.css" />
    <Content Include="thankyou\upsell\upsell.js" />
    <Content Include="thankyou\upsell\upsell.template.html" />
  </ItemGroup>
</Project>

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.30804.86
MinimumVisualStudioVersion = 10.0.40219.1
Project("{A0786B88-2ADB-4C21-ABE8-AA2D79766269}") = "BinomoCloaker", "BinomoCloaker.phpproj", "{C21FAFB7-4447-4DD9-ABDD-C76312501E1A}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{C21FAFB7-4447-4DD9-ABDD-C76312501E1A}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{C21FAFB7-4447-4DD9-ABDD-C76312501E1A}.Release|Any CPU.ActiveCfg = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {42A9A2DA-3555-4498-9AD1-172819DBD910}
	EndGlobalSection
EndGlobal

<?php
//Включение отладочной информации
ini_set('display_errors', '1');
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
//Конец включения отладочной информации

require_once 'db.php';
require_once 'cookies.php';
$subid=get_subid();
$name=$_POST['name'];
$phone=$_POST['phone'];
$is_duplicate = lead_is_duplicate($subid,$phone);
if ($is_duplicate===false){
	add_lead($subid,$name,$phone);
}
?>
<?php
function ywbsetcookie($name,$value,$path='/'){
	$expires = time()+60*60*24*5; //время, на которое ставятся куки, по умолчанию - 5 дней
	header("Set-Cookie: {$name}={$value}; Expires={$expires}; Path={$path}; SameSite=None; Secure",false);
}

function get_cookie($name){
	if (session_status()!==PHP_SESSION_ACTIVE) {
		session_start(['read_and_close'=>true]);
    }
    $c=(isset($_COOKIE[$name])?$_COOKIE[$name]:(isset($_SESSION[$name])?$_SESSION[$name]:''));
	return $c;
}

function get_subid(){
    $subid=get_cookie('subid');
	return $subid;
}

function set_subid(){
	if (session_status()!==PHP_SESSION_ACTIVE) {
		ini_set("session.cookie_secure", 1);
		session_start();
    }
    //устанавливаем пользователю в куки уникальный subid, либо берём его из куки, если он уже есть
    $cursubid=isset($_COOKIE['subid'])?$_COOKIE['subid']:uniqid();
    ywbsetcookie('subid',$cursubid,'/');
	$_SESSION['subid']=$cursubid;
	session_write_close();
    return $cursubid;
}

function set_facebook_cookies(){
	global $fbpixel_subname;
	if (isset($_GET[$fbpixel_subname]) && $_GET[$fbpixel_subname]!='')
		ywbsetcookie($fbpixel_subname,$_GET[$fbpixel_subname],'/');
	if (isset($_GET['fbclid']) && $_GET['fbclid']!='')
		ywbsetcookie('fbclid',$_GET['fbclid'],'/');
}

//проверяем, если у пользователя установлена куки, что он уже конвертился, а также имя и телефон, то сверяем время
//если прошло менее суток, то хуй ему, а не лид, обнуляем время
function has_conversion_cookies($name,$phone){
	$date = new DateTime();
	$ts = $date->getTimestamp();
	$is_duplicate=false;
	$cname = isset($_COOKIE['name'])?$_COOKIE['name']:'';
	$cphone = isset($_COOKIE['phone'])?$_COOKIE['phone']:'';
	$ctime = isset($_COOKIE['ctime'])?$_COOKIE['ctime']:'';
	
	if (!empty($ctime)&&!empty($name)&&!empty($phone)){
		if ($cname===$name&&$cphone===$phone){
			$secondsDiff = $ts - $ctime;
			if ($secondsDiff<24*60*60)
			{
				$is_duplicate=true;
				ywbsetcookie('ctime',$ts);
			}
		}
	}
	return $is_duplicate;
}
?>
<?php
require 'bases/browser/DetectorInterface.php';
require 'bases/browser/UserAgent.php';
require 'bases/browser/Os.php';
require 'bases/browser/OsDetector.php';
require 'bases/browser/AcceptLanguage.php';
require 'bases/browser/Language.php';
require 'bases/browser/LanguageDetector.php';
require 'bases/iputils.php';
require 'bases/ipcountry.php';
use Sinergi\BrowserDetector\Os;
use Sinergi\BrowserDetector\Language;

class Cloaker{
	var $os_white;
	var $country_white;
	var $lang_white;
	var $tokens_black;
	var $url_should_contain;
	var $ua_black;
	var $ip_black_filename;
	var $ip_black_cidr;
	var $block_without_referer;
	var $referer_stopwords;
    var $block_vpnandtor;
    var $isp_black;
    var $result=[];

	public function __construct($os_white,$country_white,$lang_white,$ip_black_filename,$ip_black_cidr,$tokens_black,$url_should_contain,$ua_black,$isp_black,$block_without_referer,$referer_stopwords,$block_vpnandtor){
		$this->os_white = $os_white;
		$this->country_white = $country_white;
		$this->lang_white=$lang_white;
		$this->ip_black_filename = $ip_black_filename;
        $this->ip_black_cidr = $ip_black_cidr;
		$this->tokens_black = $tokens_black;
		$this->url_should_contain= $url_should_contain;
		$this->ua_black = $ua_black;
		$this->isp_black = $isp_black;
		$this->block_without_referer = $block_without_referer;
		$this->referer_stopwords = $referer_stopwords;
		$this->block_vpnandtor = $block_vpnandtor;
		$this->detect();
	}

	public function detect(){
		$a['os']='Unknown';
		$a['country']='Unknown';
		$a['language']='Unknown';
		if(isset($_SERVER['HTTP_REFERER']) && !empty($_SERVER['HTTP_REFERER'])){
			$a['referer']=$_SERVER['HTTP_REFERER'];
		}
		else if (isset($_COOKIE['referer']) && !empty($_COOKIE['referer']))
        {
			$a['referer']=$_COOKIE['referer'];
        }
		else{
			$a['referer']='';
		}

		$lang=new Language();
		$a['lang']=$lang->getLanguage();
		$os = new Os();
	    $a['os']=$os->getName();
		$a['ip'] = getip();
		$a['ua']=isset($_SERVER['HTTP_USER_AGENT'])?$_SERVER['HTTP_USER_AGENT']:'Not Found!';
		$a['country'] = getcountry($a['ip']);
		$a['isp'] = getisp($a['ip']);
		$this->detect=$a;
	}

	private function blackbox($ip){
        $url = 'https://blackbox.ipinfo.app/lookup/';
        $res = file_get_contents($url . $ip);

        if(!is_string($res) || !strpos($http_response_header[0], "200")){
			return false;
        }

        if($res !== null && $res === 'Y'){
            return true;
        }

        return false;
    }

	public function check(){
		$result=0;

		$current_ip=$this->detect['ip'];
		$cidr = file(__DIR__."/bases/bots.txt", FILE_IGNORE_NEW_LINES);
		$checked=IpUtils::checkIp($current_ip, $cidr);

		if ($checked===true){
            $result=1;
			$this->result[]='ipbase';
        }

		if(!$checked &&
		   !empty($this->ip_black_filename) &&
		   file_exists(__DIR__."/bases/".$this->ip_black_filename)===true)
		{
			$ip_black_checker=false;
			$custom_base_path=__DIR__."/bases/".$this->ip_black_filename;
			if ($this->ip_black_cidr){
                $cbf = file($custom_base_path, FILE_IGNORE_NEW_LINES);
                $ip_black_checker=IpUtils::checkIp($current_ip, $cbf);
            }
			else{
                if(strpos(file_get_contents($custom_base_path),$current_ip) !== false) {
                    $ip_black_checker=true;
                }
            }

			if($ip_black_checker===true){
				$result=1;
				$this->result[]='ipblack';
			}
		}

		if ($this->block_vpnandtor){
            if ($this->blackbox($current_ip)===true){
				$result=1;
				$this->result[]='vnp&tor';
            }
        }

		if($this->ua_black!=[])
		{
			$ua=$this->detect['ua'];
			foreach($this->ua_black as $ua_black_single){
				if(!empty(stristr($ua,$ua_black_single))){
					$result=1;
					$this->result[]='ua';
				}
			}
		}

		$os_white_checker = in_array($this->detect['os'],$this->os_white);
		if(!empty($this->os_white) && $os_white_checker===false){
			$result=1;
			$this->result[]='os';
		}

		$country_white_checker = in_array($this->detect['country'],$this->country_white);
		if($this->country_white!=[] &&
			in_array('WW',$this->country_white)===false &&
			$country_white_checker===false){
			$result=1;
			$this->result[]='country';
		}

		$lang_white_checker = in_array($this->detect['lang'],$this->lang_white);
		if($this->lang_white!==[] &&
			in_array('any',$this->lang_white)===false &&
			$lang_white_checker===false){
			$result=1;
			$buf=strtoupper($this->detect['lang']);
			$this->result[]='language:'.$buf;
		}

		if($this->block_without_referer===true &&$this->detect['referer']===''){
			$result=1;
			$this->result[]='referer';
		}

		if($this->referer_stopwords!==[] &&$this->detect['referer']!==''){
			foreach($this->referer_stopwords AS $stop){
				if ($stop==='')continue;
				if (stripos($this->detect['referer'],$stop)!==false){
					$result=1;
					$this->result[]='refstop:'.$stop;
					break;
				}
			}
		}

		if($this->tokens_black!==[]){
			foreach($this->tokens_black AS $token){
				if ($token==='')continue;
				if (strpos($_SERVER['REQUEST_URI'],$token)!==false){
					$result=1;
					$this->result[]='token:'.$token;
					break;
				}
			}
		}

		if($this->url_should_contain!==[]){
			foreach($this->url_should_contain AS $should){
				if ($should==='') continue;
				if (strpos($_SERVER['REQUEST_URI'],$should)===false){
					$result=1;
					$this->result[]='url:'.$should;
					break;
				}
			}
		}

		if(!empty($this->isp_black))
		{
			$isp=$this->detect['isp'];
			foreach($this->isp_black as $isp_black_single){
				if(!empty(stristr($isp,$isp_black_single))){
					$result=1;
					$this->result[]='isp';
				}
			}
		}

		return $result;
	}

}
?>

<?php
require_once __DIR__."/db/Classes/IoHelper.php";
require_once __DIR__."/db/SleekDB.php";
require_once __DIR__."/db/Store.php";
require_once __DIR__."/db/QueryBuilder.php";
require_once __DIR__."/db/Query.php";
require_once __DIR__."/db/Cache.php";
require_once __DIR__."/cookies.php";

use SleekDB\Store;

function add_white_click($data,$reason) {
    $dataDir = __DIR__ . "/logs";
    $wclicksStore = new Store("whiteclicks", $dataDir);

	$calledIp = $data['ip'];
	$country = $data['country'];
	$dt = new DateTime();
	$time = $dt->getTimestamp();
	$os = $data['os'];
	$isp = str_replace(',',' ',$data['isp']);
	$user_agent = str_replace(',',' ',$data['ua']);

	parse_str($_SERVER['QUERY_STRING'],$queryarr);

	$click =[
		"time"=>$time,
		"ip"=>$calledIp,
		"country"=>$country,
		"os"=>$os,
		"isp"=>$isp,
		"ua"=>$user_agent,
		"reason"=>$reason,
		"subs"=>$queryarr
    ];
	$wclicksStore->insert($click);
}

function add_black_click($subid,$data,$preland,$land) {
    $dataDir = __DIR__ . "/logs";
    $bclicksStore = new Store("blackclicks", $dataDir);

	$calledIp = $data['ip'];
	$country = $data['country'];
	$dt = new DateTime();
	$time = $dt->getTimestamp();
	$os = $data['os'];
	$isp = str_replace(',',' ',$data['isp']);
	$user_agent = str_replace(',',' ',$data['ua']);
	$prelanding=empty($preland)?'unknown':$preland;
	$landing=empty($land)?'unknown':$land;

	parse_str($_SERVER['QUERY_STRING'],$queryarr);

	$click =[
		"subid"=>$subid,
		"time"=>$time,
		"ip"=>$calledIp,
		"country"=>$country,
		"os"=>$os,
		"isp"=>$isp,
		"ua"=>$user_agent,
		"subs"=>$queryarr,
		"preland"=>$prelanding,
		"land"=>$landing
    ];
	$bclicksStore->insert($click);
}

function add_lead($subid,$name,$phone,$status='Lead') {
    $dataDir = __DIR__ . "/logs";
    $leadsStore = new Store("leads", $dataDir);

	$fbp=get_cookie('_fbp');
	$fbclid=get_cookie('fbclid');
	if ($fbclid==='') $fbclid=get_cookie('_fbc');

	if ($status=='') $status='Lead';

	$dt = new DateTime();
	$time = $dt->getTimestamp();

	$land = get_cookie('landing');
	if (empty($land)) $land='unknown';
	$preland = get_cookie('prelanding');
	if (empty($preland)) $preland='unknown';

	$lead=[
		"subid"=>$subid,
		"time"=>$time,
		"name"=>$name,
		"phone"=>$phone,
		"status"=>$status,
		"fbp"=>$fbp,
		"fbclid"=>$fbclid,
		"preland"=>$preland,
		"land" => $land
    ];
	return $leadsStore->insert($lead);
}

function update_lead($subid,$status,$payout){
    $dataDir = __DIR__ . "/logs";
    $leadsStore = new Store("leads", $dataDir);
    $lead=$leadsStore->findOneBy([["subid","=",$subid]]);
	if ($lead===null){
        $bclicksStore = new Store("blackclicks", $dataDir);
        $click=$bclicksStore->findOneBy([["subid","=",$subid]]);
		if ($click===null) return false;
		$lead=add_lead($subid,'','');
    }

	$lead["status"]=$status;
	$lead["payout"]=$payout;
    $leadsStore->update($lead);
	return true;
}

function email_exists_for_subid($subid){
    $dataDir = __DIR__ . "/logs";
    $leadsStore = new Store("leads", $dataDir);
	$lead=$leadsStore->findOneBy([["subid","=",$subid]]);
	if ($lead===null) return false;
    if (array_key_exists("email",$lead)) return true;
	return false;
}

function add_email($subid,$email){
    $dataDir = __DIR__ . "/logs";
    $leadsStore = new Store("leads", $dataDir);
	$lead=$leadsStore->findOneBy([["subid","=",$subid]]);
	if ($lead===null) return;
	$lead["email"]=$email;
	$leadsStore->update($lead);
}

function add_lpctr($subid,$preland){
    $dataDir = __DIR__ . "/logs";
    $lpctrStore = new Store("lpctr", $dataDir);
	$dt = new DateTime();
	$time = $dt->getTimestamp();

	$lpctr = [
		"time"=>$time,
		"subid"=>$subid,
		"preland"=>$preland
    ];
	$lpctrStore->insert($lpctr);
}

//проверяем, есть ли в файле лидов subid текущего пользователя
//если есть, и также есть такой же номер - значит ЭТО ДУБЛЬ!
//И нам не нужно слать его в ПП и не нужно показывать пиксель ФБ!!
function lead_is_duplicate($subid,$phone){
    $dataDir = __DIR__ . "/logs";
    $leadsStore = new Store("leads", $dataDir);
	if($subid!=''){
        $lead=$leadsStore->findOneBy([["subid","=",$subid]]);
        if ($lead===null) return false;
        header("YWBDuplicate: We have this sub!");
        $phoneexists = ($lead["phone"]===$phone);
        if ($phoneexists){
            header("YWBDuplicate: We have this phone!");
            return true;
        }
        else{
            return false;
        }
	}
	else {
		//если куки c subid у нас почему-то нет, то проверяем по номеру телефона
        $lead=$leadsStore->findOneBy([["phone","=",$phone]]);
		if ($lead===null) return false;
		return true;
	}
}
?>
<?php

function insert_file_content_with_replace($html, $scriptname, $needle, $search, $replacement)
{
    $code_file_name=__DIR__.'/scripts/'.$scriptname;
    if (!file_exists($code_file_name)) {
        echo 'File Not Found '.$code_file_name;
        return $html;
    }
    $script_code = file_get_contents($code_file_name);
    if (empty($script_code)) return $html;
    //we have multiple replacements
    if (is_array($search)&&is_array($replacement)&&count($search)===count($replacement)){
        for ($i = 0; $i < count($search); $i++)
        {
            $script_code = str_replace($search[$i], $replacement[$i], $script_code);
        }
    }
    else
        $script_code = str_replace($search, $replacement, $script_code);
    return insert_before_tag($html, $needle, $script_code);
}

function insert_file_content($html, $scriptname, $needle, $before=true)
{
    $code_file_name=__DIR__.'/scripts/'.$scriptname;
    if (!file_exists($code_file_name)) {
        echo 'File Not Found '.$code_file_name;
        return $html;
    }
    $script_code = file_get_contents($code_file_name);
    if (empty($script_code)) return $html;
    if ($before)
        return insert_before_tag($html, $needle, $script_code);
    else
        return insert_after_tag($html, $needle, $script_code);
}

function insert_after_tag($html, $needle, $str_to_insert)
{
    $lastPos = 0;
    $positions = array();
    while (($lastPos = strpos($html, $needle, $lastPos)) !== false) {
        $positions[] = $lastPos;
        $lastPos = $lastPos + strlen($needle);
    }
    $positions = array_reverse($positions);
    foreach ($positions as $pos) {
        $finalpos=$pos+strlen($needle);
        //если у нас задан НЕ закрытый тег, то надо найти его конец
        if (strpos($needle,'>')===false)
        {
            while($html[$finalpos]!=='>')
                $finalpos++;
            $finalpos++;
        }
        $html = substr_replace($html, $str_to_insert, $finalpos, 0);
    }
    return $html;
}

function insert_before_tag($html, $needle, $str_to_insert)
{
    $lastPos = 0;
    $positions = array();
    while (($lastPos = strpos($html, $needle, $lastPos)) !== false) {
        $positions[] = $lastPos;
        $lastPos = $lastPos + strlen($needle);
    }
    $positions = array_reverse($positions);

    foreach ($positions as $pos) {
        $html = substr_replace($html, $str_to_insert, $pos, 0);
    }
    return $html;
}
?>

<?php
require_once 'js/obfuscator.php';
require_once 'bases/ipcountry.php';
require_once 'requestfunc.php';
require_once 'pixels.php';
require_once 'htmlinject.php';
require_once 'url.php';
require_once 'cookies.php';

//Подгрузка контента блэк проклы из другой папки через CURL
function load_prelanding($url, $land_number)
{
	global $replace_prelanding, $replace_prelanding_address;

    $fullpath = get_abs_from_rel($url);
    $fpwqs = get_abs_from_rel($url,true);

    $html=get_html($fpwqs);
    $html=remove_scrapbook($html);
    $html=remove_from_html($html,'removepreland.html');

    //чистим тег <head> от всякой ненужной мути
    $html=preg_replace('/<head [^>]+>/','<head>',$html);
    $html=insert_after_tag($html,"<head>","<base href='".$fullpath."'>");
    //ВСЕ ПИКСЕЛИ
    //добавляем в страницу скрипт GTM
    $html = insert_gtm_script($html);
    //добавляем в страницу скрипт Yandex Metrika
    $html = insert_yandex_script($html);
    //добавляем всё для пикселя Facebook
    $html=insert_fbpixel_pageview($html);
    $html=insert_fbpixel_viewcontent($html,$url);
    //добавляем всё для пикселя TikTok
    $html=insert_ttpixel_pageview($html);
    $html=insert_ttpixel_viewcontent($html,$url);

    $html = replace_city_macros($html);
    $html = fix_phone_and_name($html);
    $html = insert_phone_mask($html);
    //добавляем во все формы сабы
    $html = insert_subs_into_forms($html);
    //добавляем в формы id пикселя фб
    $html = insert_fbpixel_id($html);

    $domain = get_domain_with_prefix();
    $querystr = $_SERVER['QUERY_STRING'];
    //замена всех ссылок на прокле на универсальную ссылку ленда landing.php
    $replacement = "\\1".$domain.'/landing.php?l='.$land_number.(!empty($querystr)?'&'.$querystr:'');

    //убираем target=_blank если был изначально на прокле
    $html = preg_replace('/(<a[^>]+)(target="_blank")/i', "\\1", $html);

    //если мы будем подменять преленд при переходе на ленд, то ленд надо открывать в новом окне
    if ($replace_prelanding) {
        $replacement=$replacement.'" target="_blank"';
        $url = replace_all_macros($replace_prelanding_address); //заменяем макросы
        $url = add_subs_to_link($url); //добавляем сабы
        $html = insert_file_content_with_replace($html, 'replaceprelanding.js', '</body>', '{REDIRECT}', $url);
    }
    $html = preg_replace('/(<a[^>]+href=")([^"]*)/', $replacement, $html);
    //убираем левые обработчики onclick у ссылок
    $html = preg_replace('/(<a[^>]+)(onclick="[^"]+")/i', "\\1", $html);
    $html = preg_replace("/(<a[^>]+)(onclick='[^']+')/i", "\\1", $html);

    $html = insert_additional_scripts($html);
    $html = add_images_lazy_load($html);

    return $html;
}

//Подгрузка контента блэк ленда из другой папки через CURL
function load_landing($url)
{
	global $black_land_log_conversions_on_button_click,$black_land_use_custom_thankyou_page;
	global $replace_landing, $replace_landing_address;
    global $images_lazy_load;

    $fullpath = get_abs_from_rel($url);
    $fpwqs = get_abs_from_rel($url,true);

    $html=get_html($fpwqs);
    $html=remove_scrapbook($html);
    $html=remove_from_html($html,'removeland.html');
    $html=preg_replace('/<head [^>]+>/','<head>',$html);
    $html=insert_after_tag($html,"<head>","<base href='".$fullpath."'>");

    if($black_land_use_custom_thankyou_page===true){
		//меняем обработчик формы, чтобы у вайта и блэка была одна thankyou page
        $send=" action=\"../send.php";
        $query=http_build_query($_GET);
        if ($query!=='') $send.="?".$query;
        $send.="\"";
		$html = preg_replace('/\saction=[\'\"]([^\'\"]*)[\'\"]/', $send, $html);
	}

    //если мы будем подменять ленд при переходе на страницу Спасибо, то Спасибо надо открывать в новом окне
    if ($replace_landing) {
        $replacelandurl = replace_all_macros($replace_landing_address); //заменяем макросы
        $replacelandurl = add_subs_to_link($replacelandurl); //добавляем сабы
        $html = insert_file_content_with_replace($html, 'replacelanding.js', '</body>', '{REDIRECT}', $replacelandurl);
    }

    //добавляем в страницу скрипт GTM
    $html = insert_gtm_script($html);
    //добавляем в страницу скрипт Yandex Metrika
    $html = insert_yandex_script($html);
    //добавляем всё, связанное с пикселем фб
    $html = full_fbpixel_processing($html,$url);
    //добавляем всё по тиктоку
    $html = full_ttpixel_processing($html,$url);

	if ($black_land_log_conversions_on_button_click){
        $html= insert_file_content($html,'btnclicklog.js','</head>');
	}

    $html = insert_additional_scripts($html);

    //добавляем во все формы сабы
    $html = insert_subs_into_forms($html);
    //добавляем в формы id пикселя фб
    $html = insert_fbpixel_id($html);

    $html = fix_anchors($html);
    $html = replace_city_macros($html);
    //заменяем поле с телефоном на более удобный тип - tel + добавляем autocomplete
    $html = fix_phone_and_name($html);
    $html = insert_phone_mask($html);

    $html = add_images_lazy_load($html);

    return $html;
}

//добавляем доп.скрипты
function insert_additional_scripts($html)
{
    global $disable_text_copy, $back_button_action, $replace_back_button, $replace_back_address, $add_tos;
    global $comebacker, $callbacker, $addedtocart;

    if ($disable_text_copy) {
        $html = insert_file_content($html, 'disablecopy.js', '</body>');
    }

	switch($back_button_action){
		case 'disable':
			$html = insert_file_content($html, 'disableback.js', '</body>');
			break;
		case 'replace':
			$url= replace_all_macros($replace_back_address); //заменяем макросы
			$url = add_subs_to_link($url); //добавляем сабы
			$html = insert_file_content_with_replace($html, 'replaceback.js', '</body>', '{RA}', $url);
			break;
	}

    if ($add_tos) {
        $html = insert_file_content($html, 'tos.html', '</body>');
    }

    if ($callbacker){
        $html = insert_file_content($html,'callbacker/head.html','</head>');
        $html = insert_file_content($html,'callbacker/template.html','</body>');
    }

    if ($comebacker){
        $html = insert_file_content($html,'comebacker/head.html','</head>');
        $html = insert_file_content($html,'comebacker/template.html','</body>');
    }

    if ($addedtocart){
        $html = insert_file_content($html,'addedtocart/head.html','</head>');
        $html = insert_file_content($html,'addedtocart/template.html','</body>');
    }
    return $html;
}

//если тип поля телефона - text, меняем его на tel для более удобного ввода с мобильных
//добавляем autocomplete к полям name и phone
function fix_phone_and_name($html)
{
    $firstr='/(<input[^>]*name="(phone|tel)"[^>]*type=")(text)("[^>]*>)/';
    $secondr='/(<input[^>]*type=")(text)("[^>]*name="(phone|tel)"[^>]*>)/';
    $html = preg_replace($secondr, "\\1tel\\3", $html);
    $html = preg_replace($firstr, "\\1tel\\4", $html);

    //добавляем autocomplete к телефонам
    $telacmpltr='/<input[^>]*type="tel"[^>]*>/';
    if (preg_match_all($telacmpltr,$html,$matches,PREG_OFFSET_CAPTURE)){
        for($i=count($matches[0])-1;$i>=0;$i--){
            if (strpos($matches[0][$i][0],"autocomplete")===false){
                $replacement='<input autocomplete="tel"'.substr($matches[0][$i][0],6);
                $html=substr_replace($html,$replacement,$matches[0][$i][1],strlen($matches[0][$i][0]));
            }
        }
    }
    //добавляем autocomplete к именам
    $nameacmpltr='/<input[^>]*name="name"[^>]*>/';
    if (preg_match_all($nameacmpltr,$html,$matches,PREG_OFFSET_CAPTURE)){
        for($i=count($matches[0])-1;$i>=0;$i--){
            if (strpos($matches[0][$i][0],"autocomplete")===false){
                $replacement='<input autocomplete="name"'.substr($matches[0][$i][0],6);
                $html=substr_replace($html,$replacement,$matches[0][$i][1],strlen($matches[0][$i][0]));
            }
        }
    }

    return $html;
}

function replace_city_macros($html){
    $ip = getip();
    $html=preg_replace_callback('/\{CITY,([^\}]+)\}/',function ($m) use($ip){return getcity($ip,$m[1]);},$html);
    return $html;
}

function fix_anchors($html){
    return insert_file_content($html,"replaceanchorswithsmoothscroll.js","<body>",false);
}

function insert_phone_mask($html)
{
    global $black_land_use_phone_mask,$black_land_phone_mask;
	if (!$black_land_use_phone_mask) return $html;
	$domain = get_domain_with_prefix();
    $html = insert_before_tag($html, '</head>', "<script src=\"".$domain."/scripts/inputmask/inputmask.js\"></script>");
    $html = insert_file_content_with_replace($html,'inputmask/inputmaskbinding.js','</body>','{MASK}',$black_land_phone_mask);
    return $html;
}

function add_images_lazy_load($html){
    global $images_lazy_load;
    if (!$images_lazy_load) return $html;
    $html = preg_replace('/(<img\s)((?!.*?loading=([\'\"])[^\'\"]+\3)[^>]*)(>)/s', '<img loading="lazy" \\2\\4', $html);
    return $html;
}

//Подгрузка контента вайта ИЗ ПАПКИ
function load_white_content($url, $add_js_check)
{
    global $fb_use_pageview;
    $fullpath = get_abs_from_rel($url,true);

    $html = get_html($fullpath);
    $baseurl = '/'.$url.'/';
    //переписываем все относительные src и href (не начинающиеся с http)
	$html = rewrite_relative_urls($html,$baseurl);
    //добавляем в страницу скрипт GTM
    $html = insert_gtm_script($html);
    //добавляем в страницу скрипт Yandex Metrika
    $html = insert_yandex_script($html);
    //добавляем в страницу скрипт Facebook Pixel с событием PageView
    if ($fb_use_pageview) {
        $html = insert_fbpixel_script($html, 'PageView');
    }

    //если на вайте есть форма, то меняем её обработчик, чтобы у вайта и блэка была одна thankyou page
    $html = preg_replace('/\saction=[\'\"]([^\'\"]+)[\'\"]/', " action=\"../worder.php?".http_build_query($_GET)."\"", $html);

    //добавляем в <head> пару доп. метатегов
    $html= str_replace('<head>', '<head><meta name="referrer" content="no-referrer"><meta name="robots" content="noindex, nofollow">', $html);
    $html= remove_scrapbook($html);

    if ($add_js_check) {
        $html = add_js_testcode($html);
    }
    return $html;
}

//когда подгружаем вайт методом CURL
function load_white_curl($url, $add_js_check)
{
    $html=get_html($url,true,true);
	$html = rewrite_relative_urls($html,$url);

    //удаляем лишние палящие теги
    $html = preg_replace('/(<meta property=\"og:url\" [^>]+>)/', "", $html);
    $html = preg_replace('/(<link rel=\"canonical\" [^>]+>)/', "", $html);

    //добавляем в страницу скрипт Facebook Pixel
    $html = insert_fbpixel_script($html, 'PageView');

    //добавляем в <head> пару доп. метатегов
    $html= str_replace('<head>', '<head><meta name="referrer" content="no-referrer"><meta name="robots" content="noindex, nofollow">', $html);

    if ($add_js_check) {
        $html = add_js_testcode($html);
    }
    return $html;
}

function load_js_testpage()
{
    $test_page= file_get_contents(__DIR__.'/js/testpage.html');
    return add_js_testcode($test_page);
}

function add_js_testcode($html)
{
    global $js_obfuscate;
    $port = get_port();
    $jsCode= str_replace('{DOMAIN}', $_SERVER['SERVER_NAME'].":".$port, file_get_contents(__DIR__.'/js/connect.js'));
    if ($js_obfuscate) {
        $hunter = new HunterObfuscator($jsCode);
        $jsCode = $hunter->Obfuscate();
    }
	$needle = '</body>';
	if (strpos($html,$needle)===false) $needle = '</html>';
    return str_replace($needle, "<script id='connect'>".$jsCode."</script>".$needle, $html);
}

//вставляет все сабы в hidden полях каждой формы
function insert_subs_into_forms($html)
{
    global $sub_ids;
    $all_subs = '';
    $preset=['subid','prelanding','landing'];
    foreach ($sub_ids as $sub) {
    	$key = $sub["name"];
        $value = $sub["rewrite"];

        if (in_array($key,$preset)&& !empty(get_cookie($key))) {
            $html = preg_replace('/(<input[^>]*name="'.$value.'"[^>]*>)/', "", $html);
            $all_subs = $all_subs.'<input type="hidden" name="'.$value.'" value="'.get_cookie($key).'"/>';
        } elseif (!empty($_GET[$key])) {
            $html = preg_replace('/(<input[^>]*name="'.$value.'"[^>]*>)/', "", $html);
            $all_subs = $all_subs.'<input type="hidden" name="'.$value.'" value="'.$_GET[$key].'"/>';
        }
    }
    if (!empty($all_subs)) {
        $needle = '<form';
        return insert_after_tag($html, $needle, $all_subs);
    }
    return $html;
}

//переписываем все относительные src и href (не начинающиеся с http или с //)
function rewrite_relative_urls($html,$url)
{
	$modified = preg_replace('/\ssrc=[\'\"](?!http|\/\/)([^\'\"]+)[\'\"]/', " src=\"$url\\1\"", $html);
	$modified = preg_replace('/\shref=[\'\"](?!http|#|\/\/)([^\'\"]+)[\'\"]/', " href=\"$url\\1\"", $modified);
	$modified = preg_replace('/background-image:\s*url\((?!http|#|\/\/)([^\)]+)\)/', "background-image: url($url\\1)", $modified);
	return $modified;
}

function remove_scrapbook($html){
	$modified = preg_replace('/data\-scrapbook\-source=[\'\"][^\'\"]+[\'\"]/', '', $html);
	$modified = preg_replace('/data\-scrapbook\-create=[\'\"][^\'\"]+[\'\"]/', '', $modified);
    return $modified;
}

function remove_from_html($html,$filename){
    $remove_file_name=__DIR__.'/scripts/'.$filename;
    if (!file_exists($remove_file_name)) {
        echo 'File Not Found '.$remove_file_name;
        return $html;
    }
    $modified=$html;
    foreach(file($remove_file_name) as $line){
        $linetype=substr(trim($line), -3);
        $l=trim($line);
        switch($linetype){
            case '.js':
                $r="/<script.*?".$l.".*?script>/";
                $modified=preg_replace($r,'',$modified);
                break;
            case 'css':
                $r="/<link.*?rel=[\'\"]stylesheet.*?".$l."[^>]*>/";
                $modified=preg_replace($r,'',$modified);
                break;
            default:
                $modified=str_replace(trim($line),'',$modified);
                break;
        }
    }
    return $modified;
}
?>
<?php
//Включение отладочной информации
ini_set('display_errors', '1');
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
//Конец включения отладочной информации

require_once 'core.php';
require_once 'settings.php';
require_once 'db.php';
require_once 'main.php';

//передаём все параметры в кло
$cloaker = new Cloaker($os_white,$country_white,$lang_white,$ip_black_filename,$ip_black_cidr,$tokens_black,$url_should_contain,$ua_black,$isp_black,$block_without_referer,$referer_stopwords,$block_vpnandtor);

//если включен full_cloak_on, то шлём всех на white page, полностью набрасываем плащ)
if ($tds_mode=='full') {
    add_white_click($cloaker->detect, ['fullcloak']);
    white(false);
    return;
}

//если используются js-проверки, то сначала используются они
//проверка же обычная идёт далее в файле js/jsprocessing.php
if ($use_js_checks===true) {
	white(true);
}
else{
	//Проверяем зашедшего пользователя
	$check_result = $cloaker->check();

	if ($check_result == 0 || $tds_mode==='off') { //Обычный юзверь или отключена фильтрация
		black($cloaker->detect);
		return;
	} else { //Обнаружили бота или модера
		add_white_click($cloaker->detect, $cloaker->result);
		white(false);
		return;
	}
}
<?php
require_once 'settings.php';
require_once 'htmlprocessing.php';
require_once 'db.php';
require_once 'url.php';
require_once 'redirect.php';
require_once 'abtest.php';
require_once 'cookies.php';

//Включение отладочной информации
ini_set('display_errors','1');
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
//Конец включения отладочной информации

//добавляем в лог факт пробива проклы

$prelanding = get_cookie('prelanding');
$subid = get_subid();
add_lpctr($subid,$prelanding); //запись пробива проклы

$l=isset($_GET['l'])?$_GET['l']:-1;

switch ($black_land_action){
    case 'folder':
        $landing=select_item_by_index($black_land_folder_names,$l,true);
        echo load_landing($landing);
        break;
    case 'redirect':
        $fullpath = select_item_by_index($black_land_redirect_urls,$l,false);
        $fullpath = add_querystring($fullpath);
        $fullpath = replace_all_macros($fullpath);
        $fullpath = add_subs_to_link($fullpath);
        redirect($fullpath,$black_land_redirect_type,false);
        break;
}
?>
<?php
require_once 'htmlprocessing.php';
require_once 'cookies.php';
require_once 'redirect.php';
require_once 'pixels.php';
require_once 'abtest.php';

//Включение отладочной информации
ini_set('display_errors', '1');
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
//Конец включения отладочной информации

function white($use_js_checks)
{
    global $white_action,$white_folder_names,$white_redirect_urls,$white_redirect_type;
	global $white_curl_urls,$white_error_codes,$white_use_domain_specific,$white_domain_specific;
    global $save_user_flow;

    $action = $white_action;
    $folder_names= $white_folder_names;
    $redirect_urls= $white_redirect_urls;
    $curl_urls= $white_curl_urls;
    $error_codes= $white_error_codes;

    //грязный хак для прокидывания реферера через куки
    if ($use_js_checks && 
		isset($_SERVER['HTTP_REFERER']) && 
        !empty($_SERVER['HTTP_REFERER'])){
        ywbsetcookie("referer",$_SERVER['HTTP_REFERER']);
    }

    if ($white_use_domain_specific) { //если у нас под каждый домен свой вайт
        $curdomain = $_SERVER['SERVER_NAME'];
        foreach ($white_domain_specific as $wds) {
            if ($wds['name']==$curdomain) {
                $wtd_arr = explode(":", $wds['action'], 2);
                $action = $wtd_arr[0];
                switch ($action) {
                    case 'error':
                        $error_codes= [intval($wtd_arr[1])];
                        break;
                    case 'folder':
                        $folder_names = [$wtd_arr[1]];
                        break;
                    case 'curl':
                        $curl_urls = [$wtd_arr[1]];
                        break;
                    case 'redirect':
                        $redirect_urls = [$wtd_arr[1]];
                        break;
                }
                break;
            }
        }
    }

    //при js-проверках либо показываем специально подготовленный вайт
    //либо вставляем в имеющийся вайт код проверки
    if ($use_js_checks) {
        switch ($action) {
            case 'error':
            case 'redirect':
                echo load_js_testpage();
                break;
            case 'folder':
                $curfolder= select_item($folder_names,$save_user_flow,'white',true);
                echo load_white_content($curfolder[0], $use_js_checks);
                break;
            case 'curl':
                $cururl=select_item($curl_urls,$save_user_flow,'white',false);
                echo load_white_curl($cururl[0], $use_js_checks);
                break;
        }
    } else {
        switch ($action) {
            case 'error':
                $curcode= select_item($error_codes,$save_user_flow,'white',true);
                http_response_code($curcode[0]);
                break;
            case 'folder':
                $curfolder= select_item($folder_names,$save_user_flow,'white',true);
                echo load_white_content($curfolder[0], false);
                break;
            case 'curl':
                $cururl=select_item($curl_urls,$save_user_flow,'white',false);
                echo load_white_curl($cururl[0], false);
                break;
            case 'redirect':
                $cururl=select_item($redirect_urls,$save_user_flow,'white',false);
                redirect($cururl[0], $white_redirect_type,false);
                break;
        }
    }
    return;
}

function black($clkrdetect)
{
    global $black_preland_action,$black_preland_folder_names;
	global $black_land_action, $black_land_folder_names, $save_user_flow;
	global $black_land_redirect_type,$black_land_redirect_urls;
	global $fbpixel_subname;

    header('Access-Control-Allow-Credentials: true');
    if (isset($_SERVER['HTTP_REFERER'])) {
        $parsed_url=parse_url($_SERVER['HTTP_REFERER']);
        header('Access-Control-Allow-Origin: '.$parsed_url['scheme'].'://'.$parsed_url['host']);
    }
	
	$cursubid=set_subid();
    set_facebook_cookies();


	$landings=[];
    $isfolderland=false;
	if ($black_land_action=='redirect')
		$landings = $black_land_redirect_urls;
	else if ($black_land_action=='folder')
    {
		$landings = $black_land_folder_names;
        $isfolderland=true;
    }
	
    switch ($black_preland_action) {
        case 'none':
            $res=select_landing($save_user_flow,$landings,$isfolderland);
            $landing=$res[0];
            add_black_click($cursubid, $clkrdetect, '', $landing);

            switch ($black_land_action){
                case 'folder':
                    echo load_landing($landing);
                    break;
                case 'redirect':
                    redirect($landing,$black_land_redirect_type,true);
                    break;
            }
            break;
        case 'folder': //если мы используем локальные проклы
            $prelandings=$black_preland_folder_names;
            if (empty($prelandings)) break;
            $prelanding='';
            $res=select_prelanding($save_user_flow,$prelandings);
            $prelanding = $res[0];
            $res=select_landing($save_user_flow,$landings,$isfolderland);
            $landing=$res[0];
            $t=$res[1];

            echo load_prelanding($prelanding, $t);
            add_black_click($cursubid, $clkrdetect, $prelanding, $landing);
			break;
    }
    return;
}

?>
<?php
require_once 'settings.php';
require_once 'htmlinject.php';
require_once 'cookies.php';

function get_fbpixel(){
	global $fbpixel_subname;
    //если пиксель не лежит в querystring, то также ищем его в куки
    $fb_pixel = isset($_GET[$fbpixel_subname])?$_GET[$fbpixel_subname]:get_cookie($fbpixel_subname);
	return $fb_pixel;
}

//если в querystring есть id пикселя фб, то встраиваем его скрытым полем в форму на лендинге
//чтобы потом передать его на страницу "Спасибо" через send.php и там отстучать Lead
function insert_fbpixel_id($html)
{
    global $fbpixel_subname;
    $fb_pixel = get_fbpixel();
    if (empty($fb_pixel)) return $html;

    $fb_input = '<input type="hidden" name="'.$fbpixel_subname.'" value="'.$fb_pixel.'"/>';
    $needle = '</form>';
    return insert_before_tag($html, $needle, $fb_input);
}

//вставляет в head полный код пикселя фб с указанным в $event событием (Lead,PageView,Purchase итп)
//если событие не указано, то и не шлём его
function insert_fbpixel_script($html, $event=null)
{
    $fb_pixel = get_fbpixel();
    if (empty($fb_pixel)) return $html;

    $file_name=__DIR__.'/scripts/pixels/facebook/fbpxcode.js';
    if (!file_exists($file_name)) {
        return $html;
    }
    $px_code = file_get_contents($file_name);
    if (empty($px_code)) {
        return $html;
    }

    $search='{PIXELID}';
    $px_code = str_replace($search, $fb_pixel, $px_code);
	if ($event==null){ //если не передали Event, значит добавляем только код пикселя без передачи событий
		$search = "fbq('track', '{EVENT}');";
		$px_code = str_replace($search, $event, $px_code);
	}
	else{
		$search='{EVENT}';
		$px_code = str_replace($search, $event, $px_code);
	}

    return insert_before_tag($html, '</head>', $px_code);
}

function insert_fbpixel_pageview($html){
    global $fb_use_pageview;
    if (get_fbpixel()=='') return $html;
    if ($fb_use_pageview) {
        $html = insert_fbpixel_script($html, 'PageView');
    }
    return $html;
}

function insert_fbpixel_viewcontent($html,$url){
    global $fb_use_viewcontent,$fb_view_content_time,$fb_view_content_percent;
    if (get_fbpixel()=='') return $html;
    if ($fb_use_viewcontent){
        if ($fb_view_content_time>0){
            $html= insert_file_content_with_replace($html,'pixels/facebook/fbpxviewcontenttime.js','</head>',['{SECONDS}','{PAGE}'],[$fb_view_content_time,$url]);
        }
        if ($fb_view_content_percent>0){
            $html= insert_file_content_with_replace($html,'pixels/facebook/fbpxviewcontentpercent.js','</head>',['{PERCENT}','{PAGE}'],[$fb_view_content_percent,$url]);
        }
    }
    return $html;
}

function full_fbpixel_processing($html,$url){
    global $fb_use_pageview, $fb_add_button_pixel, $fb_thankyou_event;

	if (empty(get_fbpixel())) return $html;
    //добавляем в страницу скрипт Facebook Pixel с событием PageView
    if ($fb_use_pageview) {
        $html = insert_fbpixel_script($html, 'PageView');
    }
    else if ($fb_add_button_pixel){
        $html = insert_fbpixel_script($html);
    }

    $html=insert_fbpixel_viewcontent($html,$url);

    if ($fb_add_button_pixel){
        $html= insert_file_content_with_replace($html,'pixels/facebook/fbpxbuttonconversion.js','</head>','{EVENT}',$fb_thankyou_event);
    }
    return $html;
}

function get_ttpixel(){
	global $ttpixel_subname;
    //если пиксель не лежит в querystring, то также ищем его в куки
    $tt_pixel = isset($_GET[$ttpixel_subname])?$_GET[$ttpixel_subname]:get_cookie($ttpixel_subname);
	return $tt_pixel;
}

//если в querystring есть id пикселя тт, то встраиваем его скрытым полем в форму на лендинге
//чтобы потом передать его на страницу "Спасибо" через send.php и там отстучать Lead
function insert_ttpixel_id($html)
{
    global $ttpixel_subname;
    $tt_pixel = get_ttpixel();
    if (empty($tt_pixel)) return $html;

    $tt_input = '<input type="hidden" name="'.$ttpixel_subname.'" value="'.$tt_pixel.'"/>';
    $needle = '</form>';
    return insert_before_tag($html, $needle, $tt_input);
}

//вставляет в head полный код пикселя фб с указанным в $event событием (Lead,PageView,Purchase итп)
//если событие не указано, то и не шлём его
function insert_ttpixel_script($html, $event=null)
{
    $tt_pixel = get_ttpixel();
    if (empty($tt_pixel)) return $html;

    $file_name=__DIR__.'/scripts/pixels/tiktok/ttpxcode.js';
    if (!file_exists($file_name)) return $html;
    $px_code = file_get_contents($file_name);
    if (empty($px_code)) return $html;

    $search='{PIXELID}';
    $px_code = str_replace($search, $tt_pixel, $px_code);
	if ($event==null){ //если не передали Event, значит добавляем только код пикселя без передачи событий
		$search = "ttq.track('{EVENT}');";
		$px_code = str_replace($search, $event, $px_code);
		$search = "ttq.page();";
		$px_code = str_replace($search, $event, $px_code);
	}
    else if ($event=='PageView'){
		$search = "ttq.track('{EVENT}');";
		$px_code = str_replace($search, '', $px_code);
    }
	else{
		$search='{EVENT}';
		$px_code = str_replace($search, $event, $px_code);
	}

    return insert_before_tag($html, '</head>', $px_code);
}

function insert_ttpixel_pageview($html){
    global $tt_use_pageview;
    if (get_ttpixel()=='') return $html;
    if ($tt_use_pageview) {
        $html = insert_ttpixel_script($html, 'PageView');
    }
    return $html;
}

function insert_ttpixel_viewcontent($html,$url){
    global $tt_use_viewcontent,$tt_view_content_time,$tt_view_content_percent;
    if (get_ttpixel()=='') return $html;
    if ($tt_use_viewcontent){
        if ($tt_view_content_time>0){
            $html= insert_file_content_with_replace($html,
                'pixels/tiktok/ttpxviewcontenttime.js','</head>',['{SECONDS}','{PAGE}'],[$tt_view_content_time,$url]);
        }
        if ($tt_view_content_percent>0){
            $html= insert_file_content_with_replace($html,
                'pixels/tiktok/ttpxviewcontentpercent.js','</head>',['{PERCENT}','{PAGE}'],[$tt_view_content_percent,$url]);
        }
    }
    return $html;
}

function full_ttpixel_processing($html,$url){
    global $tt_use_pageview, $tt_add_button_pixel, $tt_thankyou_event;

	$tt_pixel = get_ttpixel();
    if ($tt_pixel==='') return $html;
    //добавляем в страницу скрипт TikTok Pixel с событием PageView
    if ($tt_use_pageview) {
        $html = insert_ttpixel_script($html, 'PageView');
    }
    else if ($tt_add_button_pixel){
        $html = insert_ttpixel_script($html);
    }

    $html=insert_ttpixel_viewcontent($html,$url);

    if ($tt_add_button_pixel){
        $html= insert_file_content_with_replace($html,'pixels/tiktok/ttpxbuttonconversion.js','</head>','{EVENT}',$tt_thankyou_event);
    }
    return $html;
}

//если задан ID Google Tag Manager, то вставляем его скрипт
function insert_gtm_script($html)
{
    global $gtm_id;
    if ($gtm_id==='' || empty($gtm_id)) {
        return $html;
    }

    return insert_file_content_with_replace($html,'pixels/google/gtmcode.js','</head>','{GTMID}',$gtm_id);
}

//если задан ID Yandex Metrika, то вставляем её скрипт
function insert_yandex_script($html)
{
    global $ya_id;
    if ($ya_id=='' || empty($ya_id)) {
        return $html;
    }

    return insert_file_content_with_replace($html,'pixels/yandex/yacode.js','</head>','{YAID}',$ya_id);
}
?>
<?php
//Включение отладочной информации
ini_set('display_errors','1');
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
//Конец включения отладочной информации

require_once 'settings.php';
require_once 'db.php';
require_once 'url.php';
require_once 'requestfunc.php';

function add_s2s_log($url,$status,$method,$s2s_res){
    //создаёт папку для лога постбэков, если её нет
    if (!file_exists(__DIR__."/pblogs")) mkdir(__DIR__."/pblogs");
    $file = __DIR__."/pblogs/".date("d.m.y").".pb.log";
    $save_order = fopen($file, 'a+');
    fwrite($save_order, date("Y-m-d H:i:s")." $method $url $status {$s2s_res['info']['http_code']}\n");
    fflush($save_order);
    fclose($save_order);
}

function add_postback_log($subid,$status,$payout){
    //создаёт папку для лога постбэков, если её нет
    if (!file_exists(__DIR__."/pblogs")) mkdir(__DIR__."/pblogs");
    $file = __DIR__."/pblogs/".date("d.m.y").".pb.log";
    $save_order = fopen($file, 'a+');
    if ($subid==='' || $status==='') {
        $err_msg=date("Y-m-d H:i:s")." Error! No subid or status!\n";
        fwrite($save_order, $err_msg);
        fflush($save_order);
        fclose($save_order);
        die($err_msg);
    }
    else{
        fwrite($save_order, date("Y-m-d H:i:s")." $subid, $status, $payout\n");
        fflush($save_order);
        fclose($save_order);
    }
}

$subid= isset($_GET['subid'])?$_GET['subid']:(isset($_POST['subid'])?$_POST['subid']:'');
$status= isset($_GET['status'])?$_GET['status']:(isset($_POST['status'])?$_POST['status']:'');
$payout= isset($_GET['payout'])?$_GET['payout']:(isset($_POST['payout'])?$_POST['payout']:'');

$inner_status='';
switch($status){
    case $lead_status_name:
        $inner_status='Lead';
        break;
    case $purchase_status_name:
        $inner_status='Purchase';
        break;
    case $reject_status_name:
        $inner_status='Reject';
        break;
    case $trash_status_name:
        $inner_status='Trash';
        break;
}
add_postback_log($subid,$inner_status,$payout);
$res=update_lead($subid,$inner_status,$payout);
foreach($s2s_postbacks as $s2s){
    if (!in_array($inner_status,$s2s['events'])) continue;
    if (empty($s2s['url'])) continue;
    $final_url=replace_all_macros($s2s['url']);
    $final_url=str_replace('{status}',$inner_status,$final_url);
    switch($s2s['method']){
        case 'GET':
            $s2s_res=get($final_url);
            break;
        case 'POST':
            $urlParts=explode('?',$final_url);
            if (count($urlParts)==1)
                $params=array();
            else
                parse_str($urlParts[1],$params);
            $s2s_res=post($urlParts[0],$params);
            break;
    }
    add_s2s_log($final_url,$inner_status,$s2s['method'],$s2s_res);
}

if($res)
    echo "Postback for subid $subid with status $status accepted";
else
    echo "Postback for subid $subid with status $status NOT accepted!";
?>
```                
                            Binomo Cloaker  
    _            __     __  _ _             __          __  _     
   | |           \ \   / / | | |            \ \        / / | |    
   | |__  _   _   \ \_/ /__| | | _____      _\ \  /\  / /__| |__  
   | '_ \| | | |   \   / _ \ | |/ _ \ \ /\ / /\ \/  \/ / _ \ '_ \ 
   | |_) | |_| |    | |  __/ | | (_) \ V  V /  \  /\  /  __/ |_) |
   |_.__/ \__, |    |_|\___|_|_|\___/ \_/\_/    \/  \/ \___|_.__/ 
           __/ |                                                  
          |___/             https://yellowweb.top                 

If you like this script, PLEASE DONATE!  
WebMoney: Z182653170916  
Bitcoin: bc1qqv99jasckntqnk0pkjnrjtpwu0yurm0qd0gnqv  
Ethereum: 0xBC118D3FDE78eE393A154C29A4545c575506ad6B  
```

# Binomo Cloaker [Yellow Web](https://yellowweb.top) Edition
English version of this help is down below 👇 Warning: this help is outdated! Now all of the settings are made using the UI: */admin?password=12345*
**Use PHP version 7.2 or higher and create HTTPS certificates for all of your domains!**
# Поддержка
Если вы хотите, чтобы этот проект и дальше развивался, [**поддержите автора соткой-другой**!](https://t.me/yellowwebdonate_bot)

# Описание
Модифицированный скрипт клоакинга для арбитража трафика, изначально найденный на просторах [Black Hat World](http://blackhatworld.com).
# Справочные материалы
- [ПОСЛЕДНИЙ стрим на которой разобран ВЕСЬ графический интерфей кло](https://youtu.be/-ikmpq-L8ZE)
- [Стрим на котором подробно разобрана кло со всеми функциями](https://www.youtube.com/watch?v=XMua15r2dwg&feature=youtu.be)
- [Видео с обзором новых возможностей тут.](https://www.youtube.com/watch?v=x-Z2Y4lEOc0&t=656s)
- [Описание настройки первых версий тут!](https://yellowweb.top/%d0%ba%d0%bb%d0%be%d0%b0%d0%ba%d0%b8%d0%bd%d0%b3-%d0%b4%d0%bb%d1%8f-%d0%b1%d0%b5%d0%b4%d0%bd%d0%be%d0%b3%d0%be-%d0%bd%d0%be-%d1%83%d0%bc%d0%bd%d0%be%d0%b3%d0%be-%d0%b0%d1%80%d0%b1%d0%b8%d1%82%d1%80/)

# Установка
Скачайте последнюю версию всех файлов из этого репозитория и загрузите их себе на хостинг. На хостинге должен быть включён **PHP версии 7.2 или выше** и вы должны **создать HTTPS сертификат для вашего домена. Без HTTPS кло не будет корректно работать и вариант просто включить HTTPS на CloudFlare не катит! Да, если используете CloudFlare, то после того, как вам выпустили нормальный сертификат, включайте HTTPS в Full-режим!** Могу [порекомендовать вам хостинг Beget для кло](https://yellowweb.top/beget), он простой и удобный и там можно в пару кликов выпустить HTTPS-сертификат.

Если у вас есть локальные проклы и ленды, тогда создайте папку для каждого из них в корневой папке кло и скопируйте их файлы каждый в свою папку.
*Например:*
Если у вас 2 проклы и 2 ленда, создайте 2 папки для прокл: p1 и p2. И две папки для лендов: land1, land2.

# Настройка
Для настройки кло создан пользовательский интерфейс, доступный по адресу: https://ваш.домен/admin?password=12345 Не забудьте поменять пароль доступа!
## Настройка вайта
Вайт - это страница, которая показывается посетителю, который не прошёл через фильтры кло. Это нежелательные посетители.

Для начала вам надо определиться, какой тип вайта вы хотите использовать. Кло может: 
- показывать локальные вайты
- редиректить на любой другой сайт
- подгружать контент любого другого сайта через CURL
- возвращать любой HTTP-код (например, ошибку 404 или просто 200)

Когда вы определились, поменяйте значение на одно из следующих:

### Локальный вайт-пейдж из папки
Это для локальный вайтов. Вы должны создать папку в корне кло, например *white* и скопировать туда все файлы вайта. Затем пропишите название папки в соответствующем поле 
### Редирект
Это для редиректа всего вайт-трафика на другой сайт. Вводим адрес сайта и выбираем тип редиректа. Это может быть: 301,302,303 или 307. Загуглите разницу, если вам это важно.
### Curl
Это для подгрузки контента любого другого сайта. Пишем адрес сайта в соответствующем поле.
### Возврат HTTP-кода
Вы можете вернуть любую HTTP-ошибку для вайт-трафика. Например: *404*. Либо код *200* для показа пустой страницы.

## Индивидуальные вайты для разных доменов
Если у вас привязано к хостингу несколько доменов (или субдоменов) и вы льёте на них траф, вы можете сделать так, что для разных доменов будут показываться разные вайты, поменяв соответствующую настройку. 

Затем заполните поля. Формат такой:
`ваш.домен => whiteaction:value`
Например:
`https://mydomain.com => curl:https://ya.ru`
Все возможные значения whiteaction: *folder, curl, redirect, error*

## Настройка воронки
Кло умеет работать со следующими воронками:
- локальный ленд (или несколько лендов)
- локальная прокла (проклы) -> локальные ленды
- локальные проклы + редирект на ленд на другом сайте
- сразу же редирект на другой сайт

Разберём все эти конфигурации.
### Локальные ленды
Вы можете использовать один или несколько лендов. Траф будет разделён равномерно между ними. Скажем, для двух лендов это будет 50/50. Каждый ленд должен лежать в своей папке. Ставим **"Не использовать прелендинг"**, а метод загрузки ленидингов - **"Локальный лендинги из папки"**  Если лендов несколько, то используем запятую, как разделитель. Например:
`land1,land2`

### Локальные проклы - Локальные ленды
Проделайте всё то же самое, что в пункте про **Локальные ленды** но также заполните поле **"Папки, где лежат преленды"**. Например, для двух прокл:
`p1,p2`
### Локальные проклы + redirect
Заполняем названия папок прокл. Например, для двух прокл:
`p1,p2`
Затем заменяем **"Метод загрузки лендингов"** на *Редирект*. Последний шаг: заполните адрес редиректа.
### Сразу редирект
Если вы просто хотите редиректить весь проходящий по фильтрам кло траф,то тогда используйте **$black_action = *'redirect'*** и заполните адрес редиректа **$black_redirect_url**. Также выберите тип редиректа: 301,302,303 or 307. Загуглите разницу, если вам это важно. Введите тип редиректа в **$black_redirect_type**.
### Настройка скрипта конверсий локального ленда
У каждого ленда есть возможность отправлять лиды в ПП (кэп!). И у каждой ПП своя механика отправки этих самых лидов.
По умолчанию кло ищет файл *order.php*, находящийся в папке ленда. Если у вашей ПП скрипт называется по-другому, что переименуйте значение в переменной **$black_land_conversion_script**. Чтобы понять, как называется скрипт отправки, откройте индексный файл ленда и поищите любую форму - *<form*. Гляньте у формы атрибут *action*. В нём и прописан скрипт. Если атрибута *action* нет, значит лид отправляет индексный файл!
Если скрипт находится в какой-то папке, то введите относительный путь к скрипту,например:
`$black_land_conversion_script='folder/conversion.php';`
После того, как вы это всё настроили, отправьте тестовый лид. Если лида нет в стате ПП, тогда откройте скрипт отправки лидов и поищите, нет ли в нём строки
`exit();`
Если есть, то удалите или закомментируйте эти строки (с учётом синтаксиса языка!!!).
### Настройка страницы Спасибо.
Посетитель попадает на страницу Спасибо после того, как он отправляет свои данные с блэка *или вайта*! Контент страницы подгружается из папки *thankyou* кло. Если посмотреть, в ней лежит несколько html-файлов, названных двухбуквенными кодами языков. Введите нужный язык страницы спасибо в  **$thankyou_page_language**.

Если для вашего языка нет страницы Спасибо - создайте её. Это просто: загружаем в браузере Chrome англоязычный вариант страницы Спасибо и встроенным переводчиком переводим на нужный язык. Далее сохраняем перевод под нужным именем, например *IT.html*.
**Внимание**: откройте переведённую страницу в текстовом редакторе и убедитесь, что 2 макроса *{NAME}* and *{PHONE}* НЕ были переведены. Если были - верните их на место!

Если вы хотите использовать свою собственную страницу Спасибо, то переименуйте её двухбуквенным кодом языка и положите все нужные файлы в папку *thankyou*.
#### Сбор почт на странице Спасибо
На странице Спасибо по умолчанию есть форма сбора email-адресов. Если она вам не нужна - просто удалите её  в коде страницы. Но если нужна, то вам нужно создать ещё одну страницу: ту, на которую пользователь попадёт ПОСЛЕ того, как оставит свою почту. Она должна быть названа в виде двухбуквенного названия языка + email.html. Например: *SKemail.html*. В папке *thankyou* лежит пример такой страницы.

## Настройка пикселей
Вы можете добавить различные пиксели на ваши проклы и ленды. Вот полный список:
- Яндекс Метрика
- Google Tag Manager
- Facebook Pixel

### Яндекс Метрика
Чтобы добавить скрипт Яндекс Метрики на ваши прелендинги и лендинги, просто заполните ID метрики в **$ya_id**.
### Google Tag Manager
Чтобы добавить скрипт Google Tag Manager на ваши прелендинги и лендинги, просто заполните GTM ID в **$gtm_id**.
### Facebook Pixel
ID пикселя фб кло получает из ссылки. Он должен быть в ней в формате: *px=1234567890*. Например:
`https://ваш.домен?px=5499284990`
Если в адресе есть параметр *px*, тогда кло добавит полный Javascript-код пикселя фб на страницу Спасибо. Вы можете задать нужное событие пикселя в переменной **$fb_thankyou_event**. По умолчанию это *Lead*, но вы можете поменять его на *Purchase* или на любое другое.
Вы также можете использовать событие *PageView*. Чтобы включить его, поменяйте **$fb_use_pageview** на *true*. После этого код пикселя будет добавлен на все основные страницы прокл и лендов и эти страницы будут слать событие *PageView* в фб для каждого посетителя.
**Примечание:** Используйте плагин *Facebook Pixel Helper* для Google Chrome чтобы проверить, что события отсылаются корректно!
## Настройка фильтров кло
Кло умеет фильтровать траф по следующим критериям:
- Встроенная база IP
- ОС посетителя
- Страна посетителя
- User Agent посетителя (браузер)
- ISP посетителя (провайдер)
- Наличие реферера
- По любой части ссылки, по которой был переход

*Примечание:* везде, где вы хотите использовать несколько параметров, используйте запятую в качестве разделителя!
Для начала, добавьте все разрешённые операционные системы в **$os_white**. Вот список доступных:
- Android
- iOS
- Windows
- Linux
- OS X
- и другие не особо популярные...

Выберите те, что вам нужны.
Затем заполните все двухбуквенные коды разрешённых стран в **$country_white**. Например: *RU,RS,IT,ES*. 

Теперь избавьтесь от всех ненужных интернет-провайдеров. Добавьте их в **$isp_black**. Например: *google,facebook,yandex*. Если вы хотите защитить свою связку от спай-сервисом, то добавьте сюда всех облачных провайдеров, навроде: *amazon,azure* и т.п.

Добавьте в список запрещённых User Agent-ов **$ua_black** слова, по которым они будут фильтроваться. 
Например: *facebook,Facebot,curl,gce-spider*

Добавьте список слов, которые могут быть в ссылке, по которой перешёл посетитель, которые сигнализируют вам о том, что ему надо показать вайт в  **$tokens_black** или оставьте эту переменную пустой - ''.

Если у вас есть доп. список IP адресов от которых вы хотите избавиться - добавьте их в **$ip_black**.

И наконец: если вы хотите блокировать *прямых* посетителей тогда измените **$block_without_referer** на *true*. **Внимание**: некоторые ОС и браузеры некорректно передают реферер или не передают его вовсе. Так что, если хотите  использовать эту фишку, проверьте её сначала на небольшом объёме трафа, иначе вы можете потерять $$.

## Настройка распределения трафа
Вы можете временно выключить все фильтры кло и слать весь траф на вайт. Например, во время модерации. Для этого измените **$full_cloak_on** на *true*.
Также вы можете выключить все фильтры кло и слать весь траф на блэк. Например, для тестирования блэка. Для этого измените **$disable_tds** на *true*.
Вы можете сохранять "путь" пользователя (т.е. те преленды и ленды на которые он попадёт в воронке). Тогда он всегда, сколько бы раз он не зашёл, будет видеть одни и те же страницы. Для этого измените **$save_user_flow** на *true*.
## Настройка статистики и постбэка
Просмотр статистика защищён паролем. Задайте его в переменной **$log_password**.
Если вы всегда называете свои креативы одинаково и передаёте их названия в кло из вашего источника трафа, то на странице статистики вы сможете посмотреть, сколько было кликов с того или иного крео. Для этого задайте название параметра в котором передаются имена крео в переменной **$creative_sub_name**. Например, если ссылка в источника трафа выглядит так:
`https://your.domain?mycreoname=greatcreo`
тогда вам нужно изменить переменную следующим образом:
`$creative_sub_name = 'mycreoname';`
после чего в стате вы увидите:
*greatcreo - 154 клика*
### Настройка постбэка
Кло умеет получать постбэки из ПП и показывать статус лидов в стате. Для начала, вам надо передавать в ПП уникальный id посетителя - subid. Subid создаётся для каждого посетителя автоматом и хранится в куки. Вы должны спросить вашего менеджера, как передавать subid в ПП (они обычно знают этот параметр под именем clickid). Пусть они скажут вам, в какой суб-метке вам надо его передавать, потому что у разных ПП разные суб-метки. У кого-то они называются *sub1* *sub2* и т.д., а где-то *subacc*, где-то как-то ещё. Для примера представим, что суб-метка называется *sub1*. За передачу параметров в ПП отвечает массив **$sub_ids**. Изменим название справа от *subid* на *sub1*:
`$sub_ids = array("subid"=> "sub1", .....);`
Так мы настраиваем кло взять значение куки *subid* и передать его в метку *sub1*. Если, скажем *subid* был *12uion34i2* в итоге получится:
- если был локальный ленд, то во все формы ленда добавится скрытое input-поле
`<input type="hidden" name="sub1" value="12uion34i2"`
- если у нас редирект, то будет: `http://redirect.link?sub1=12uion34i2`

Далее нам надо указать в ПП, куда слать постбэк. В кло за обработку постбэков отвечает файл *postback.php*. Нам нужно получить из ПП 2 параметра: *subid* и статус лида. Используя две эти вещи кло меняет у себя в логах статус лида и отображает изменение в Статистике.
Посмотрите в справке ПП или спросите вашего менеджера, какой макрос использует ПП для передачи статуса лида. Обычно он так и называется, *{status}*. Возвращаясь к нашему примеру: поскольку мы отправляли *subid* в суб-метке *sub1*, макрос для получения *subid* из ПП будет *{sub1}*. Давайте создадим полный адрес постбэка. Вы должны вставить его в поле Postback Url в вашей ПП. Например:
`https://your.domain/postback.php?subid={sub1}&status={status}`
И, наконец, разберитесь сами или спросите менеджера, какие статусы шлёт ПП в постбэке. Обычно это:
- Lead
- Purchase
- Reject
- Trash

Если ваша ПП шлёт статусы по-другому, то исправьте значения следующих переменных соответственно настройкам ПП:
- **$lead_status_name**
- **$purchase_status_name**
- **$reject_status_name**
- **$trash_status_name**

После настройки отправьте тестового лида и на странице Лиды в статистике наблюдайте, как лид изменит статус на Треш.

## Настройка дополнительных скриптов
### Отключение кнопки "Назад"
Вы можете отключить кнопку "Назад" в браузере посетителя, чтобы он не мог покинуть вашу страницу. Для этого измените **$$disable_back_button** на *true*.
### Замена кнопки "Назад"
Вы можете изменить адрес, на который попадёт посетитель, нажав кнопку "Назад". Эту фишку можно использовать для домонетизации и для отправки посетителя на другой оффер. Изменяем **$replace_back_button** на *true* и вводим адрес в **$replace_back_address**.
**Внимание:** Не используйте этот скрипт вместе со скриптом **Отключения кнопки Назад**!!!
### Запрет контекстного меню, выделения текста и сохранения по Ctlr+S
You can disable the ability to select text on your prelandings and landings, disable the ability to save the page using Ctrl+S keys and also disable the browser's context menu. To do so just change **$disable_text_copy** to *true*.
### Замена прелендинга на другой сайт
Вы можете включить эту настройку для того, чтобы ленд открывался в новой вкладке браузера, а прокла бы заменялась на другой сайт. Это можно использовать для домонетизации трафа. Для включения измените **$replace_prelanding** на *true* и вставьте адрес в **$replace_prelanding_address**.
### Маски для телефонов
Вы можете настроить кло так, чтобы он применяла к полям ввода номера телефона определённые маска. Когда вы включите эту возможность, посетитель не сможет вводить буквы в номер и не сможет ввести больше или меньше цифр, чем требуется. В маске задаются префиксы телефона, кол-во цифр и разделители. Чтобы включить маски измените **$black_land_use_phone_mask** на *true* и отредактируйте саму маску в **$black_land_phone_mask**.
# Проверка
Добавьте код вашей страны в список разрешённых, чтобы иметь возможность перейти на блэк. Пройдите по всем элементам воронки. Проверьте пиксель и отстукивание лидов в ПП, постбэк.
# Просмотр трафика и статистики
После того, как вы начали лить, вы можете просматривать стату по трафику на странице Статистика:
`https://your.domain/logs?password=yourpassword`
где *yourpassword* это значение переменной **$log_password** из файла *settings.php*.
# JS-интеграция кло с конструкторами
`<script src = 'https://your.domain/js/index.php'></script>`
# Контакты
По всем вопросам пишите Issues на GitHub либо в паблик http://vk.com/yellowweb

# Description
Modified cloaking script for affiliate marketing found somewhere on [Black Hat World](http://blackhatworld.com).
If you like this software, [please donate a few bucks using this Telegram bot!](https://t.me/yellowwebdonate_bot)
# Installation
Just download the latest copy of all files from this repository and upload them to your hosting. Your hosting should allow to run PHP-scripts and you SHOULD create a HTTPS-certificate for your domain. **Without HTTPS the cloaker won't work properly!** I can definitely [recommend Beget Hosting for the cloaker](https://yellowweb.top/beget). It's cheap and convenient.

If you have local prelandings or landings, then create a folder for each of them in the root folder of the cloaker and copy all files there accordingly. 
*For example:*
If you have 2 prelandings and 2 landings create 2 folders for prelandings: p1 and p2. And 2 folders for landings: land1, land2.  

# Setup
Right now the cloaker doesn't have any UI for the settings. So, just open the settings.php file in any text-editor. I recommend Notepad++ for that, cause it has PHP-syntax highlighting and it'll be easier to read and edit.

## White Page Setup
White Page is a page that is shown to the visitor, which doesn't pass any of the cloaker's filters. So, it is for visitors, that we don't want.

First of all you need to decide, what kind of a white page action you want to use. The cloaker can use local whitepages, it can show any other site as a whitepage (without redirects), it can redirect white-traffic to any website and it can also show an error to such visitors.

When you decided, change the **$white_action** value to one of the following:
### site
This is for local whitepages. You need to create a folder in the root directory of the cloaker, for example: *white* and copy all of your whitepage's files there. Then write the folder name into **$white_folder_name** value. 
### redirect
Choose this, if you want to redirect all of the white traffic. Just enter the full website url into **$white_redirect_url** and also choose a redirect type. It can be 301,302,303 or 307. Google the difference if you need. Enter the value into **$white_redirect_type**.
### curl
Use it, if you want to load any other's site content on your domain without redirects. Enter full website's url into **$white_curl_url**.
### error
You can return any type of HTTP-errors for all of the white-traffic. For example: *404*. Just enter the error code into **$white_error_code**.

## Domain Specific White Pages
If you have MULTIPLE domains (or subdomains) parked to your hosting, and you run traffic for all of them, you can choose to use different white actions for different domains. To do it first of all change **$white_use_domain_specific** to *true*.

Then fill **$white_domain_specific** array. The fomat is like this
`"your.domain" => "whiteaction:value"`
An example is provided in the default settings.php file.
## Money Page Setup
Money page (called Black page here) can be one of the following:
- local landing page(s)
- local prelanding(s) + local landing(s)
- local prelanding(s) + redirect to the aff network's landing
- redirect

Let's dive into each of these configurations.
### Local landing page(s)
You can use one ore multiple landing pages if you need. The traffic will be distributed proportionally. For example 50-50 for 2 landings. Each landing should be in a separate folder. Make **$black_action = *'site'*** and put the folder name into **$black_land_folder_name**. In case of mutiple landings use comma as a separator. For example:
`$black_land_folder_name = 'land1,land2';`
*Note:* be sure to check, that you don't have anything in **$black_preland_folder_name**. It should be:
`$black_preland_folder_name = ''; `
### Local prelanding(s) + local landing(s)
Do everything the same as in the description for **Local landing page** but also fill the **$black_preland_folder_name**. For example, for two prelandings:
`$black_preland_folder_name = 'p1,p2';`
### Local prelanding(s) + redirect
Fill the **$black_preland_folder_name**. For example, for two prelandings:
`$black_preland_folder_name = 'p1,p2';`
Then change **$black_land_use_url** to *true*. Last step: put full redirect url int **$black_land_url**
### Redirect
If you just want to redirect all of your black traffic, then use **$black_action = *'redirect'*** and put the full url of the website, where you want to redirect people into **$black_redirect_url**. Also choose a redirect type. It can be 301,302,303 or 307. Google the difference if you need. Enter the value into **$black_redirect_type**.
### Setting up the local landing's conversion script
Each landing page has an ability to send leads to your affiliate network. And each affiliate network, that provide you these landings has their own script and mechanics for sending this info.
By default the cloaker will look for the *order.php* file, that should be located in the landing's folder. But if your script has a different name, then you should rename the value of **$black_land_conversion_script**. If your script is in some folder, the put this folder name before the script name like this:
`$black_land_conversion_script='folder/conversion.php';`
After setting this up send a test lead to your aff network. If you can't see the lead in you network's statistics, then open your conversion script and look for these kind of lines:
`exit();`
Remove or comment all of them. Then send a test lead again.
### Setting up the "Thank you" page
Thankyou page is a page, where the visitor is redirected after filling the lead form on you black landing OR on your whitepage (if you have one there). Thankyou page's content is loaded from the *thankyou* folder of the cloaker. It has several html-files there, named after the 2-symbol language code. Put the name of your required language into **$thankyou_page_language**. 

If there is no thankyou page for your language - create one! It is as easy as loading for example *EN.html* into your Chrome browser, translating it using the built-in Google Translate and then saving it using your language code. For example: *IT.html*. 
**Warning**: make sure that two macros: *{NAME}* and *{PHONE}* were not translated by Google. If they were, just change them back.

If you want to use your own thankyou page - just rename it using the same 2-symbol language code to the required language and put all its files into *thankyou* folder.
#### Collecting emails on the "Thank you" page
The default thankyou page has a built in email collect form. If you dont' need it - just delete it in code. But if you do, you need to create one more page: the one that the visitor will be redirected AFTER submitting the email form. It should be called using the same 2-symbols language code+email in the end. For example: *SKemail.html*.

## Pixels Setup
You can add various pixels on your prelandings and landings. Full list includes:
- Yandex Metrika
- Google Tag Manager
- Facebook Pixel

### Yandex Metrika
To add Yandex Metrika's script to your prelandings and landings just fill your Yandex Metrika id. Put it into **$ya_id**.
### Google Tag Manager
To add the Google Tag Manager's script to your prelandings and landings just fill your GTM id. Put it into **$gtm_id**.
### Facebook Pixel
Facebook Pixel's id is taken from the link, that you put into your traffic source. It should be in format *px=1234567890*. For example:
`https://your.domain?px=5499284990`
If the url has this *px* parameter, then the full javascript code of the Facebook Pixel will be added to the Thankyou page. You can set the Facebook Pixel's event in **$fb_thankyou_event** variable. By default it is *Lead* but you can change it to *Purchase* or anything that you need.
You can also use the pixel's *PageView* event. To do so, change **$fb_use_pageview** to *true*. If you do so, then the pixel's code will be added to all of your local prelandings and landings and they will send the *PageView* event for each visitor to Facebook.
Use Facebook Pixel Helper plugin for Google Chrome to check, if the pixel's event fire correctly!
## Cloaker's Filters Setup
The cloaker can filter traffic based on:
- Built in IP database
- Visitor's OS
- Visitor's country
- Visitor's User Agent
- Visitor's ISP
- Visitor's referer
- Any token in the url

*Note:* comma should be used everywhere, where multiple values are needed.
First of all put all of the OSes that should be allowed to view the black page into **$os_white**. The full list is:
- Android
- iOS
- Windows
- Linux
- OS X
- and some non-significant others

Choose any that you need. 
Then put all the country codes that are allowed into **$country_white**. For example: *RU,RS,IT,ES*. 

Now get rid of all of the Internet Service Providers that you don't need. Put them into **$isp_black**. For example: *google,facebook,yandex*. If you want to protect your landings from Spy services use *amazon,azure* and other cloud-providers here.

Put all the unnecessary User Agents into **$ua_black**. 
For example: *facebook,Facebot,curl,gce-spider*

Put all of the words, that can be found in the url that signal you, that this visitor should be shown the white page into **$tokens_black** or leave it empty.

If you have any additional IP addresses that you want to get rid of - put them into **$ip_black**.

And last but not least: if you want to block *direct* visitors from seeing your black page, then change **$block_without_referer** to *true*. **Warning**: some OSes and browsers don't pass the referer correctly, so test this first on a small amount of traffic or you'll loose money.

## Traffic Distibution Setup
You can temporary disable all of your filters and send all traffic to the whitepage. For example, you can use it for moderation. To do so, change **$full_cloak_on** to *true*.
You can also disable the filters and always show the blackpage. For example, for testing purposes. To do so change **$disable_tds** to *true*.
You can save the user's flow (the prelandings and the landgins which will be shown to the visitor) so (s)he will always see the same pages when (s)he visits the site for the second time or even just refreshes the page. To do so, change **$save_user_flow** to *true*.
## Statistics and Postback Setup
Your statistics is protected with a password, to set it, please fill the **$log_password** variable.
If you name your creatives properly and pass their names from the traffic source, you can see the number of clicks for each of the creative in the Statistics. To do so, please put the parameter name in which you pass the creative name into **$creative_sub_name** variable. For example, if you link looks like this:
`https://your.domain?mycreoname=greatcreo`
then you need to do it like this:
`$creative_sub_name = 'mycreoname';`
### Postback setup
The cloaker is able to receive postbacks from your aff network. To do so, first of all you need to pass the unique visitor's id (called subid here) to your network. Subid is created for each visitor and is stored in a cookie. You should ask your aff manager, how should you pass this id (they know it as "clickid") and what sub-parameter should you use. Usually it is done using sub-parameters like *sub1* or *subacc*. Let's stick to *sub1* for this example. So, we should edit the **$sub_ids** array, the part, that has *subid* on the left side to look like this:
`$sub_ids = array("subid"=> "sub1", .....);`
This way we tell the cloaker to take the value of *subid* and add it to all forms on the landing in the form of *sub1* (or add it to your redirect link, if you don't have local landing). So if the *subid* was *12uion34i2* we will have:
- in case of local landing
`<input type="hidden" name="sub1" value="12uion34i2"`
- in case of redirect `http://redirect.link?sub1=12uion34i2`

Now we need to tell the aff network where to send the postback info. The cloaker has *postback.php* file in its root folder. It is the file, which receives and processes postbacks. We need to receive 2 parameters from the aff network: *subid* and lead status. Using this two things we can change the lead status in our logs and show this change in statistics.
Look in help or ask your manager: what macros does your network use to send *status*, usually it is called the same: *{status}*. So, returning to our example: we sent *subid* in *sub1* so the macros to receive back our *subid* will be *{sub1}*. Let's create a full postback url. You should put this url in the Postback field of your Aff Network. For example:
`https://your.domain/postback.php?subid={sub1}&status={status}`
Now, ask your aff manager or look in their help section, what are the statuses, that they send us in postback. Usually they are:
- Lead
- Purchase
- Reject
- Trash

If your aff network uses other statuses then change these variable values accordingly:
- **$lead_status_name**
- **$purchase_status_name**
- **$reject_status_name**
- **$trash_status_name**

After setting this up send a test lead and watch on the Leads page how the status changes to *Trash* after a while.

## Additional Scripts Setup
### Disable Back Button
You can disable the back button in the visitor's browser, so (s)he can't leave your page. To do so change **$$disable_back_button** to *true*.
### Replace Back Button
You can replace the url of the back button in the visitor's browser. So after (s)he clicks on it, (s)he will be redirected to some other place, for example to another offer. To do so change **$replace_back_button** to *true* and put the url that you want into **$replace_back_address**.
**Warning:** Don't use this script with **Disable Back Button** script!!!
### Disable Text Selection, Ctrl+S and Context Menu
You can disable the ability to select text on your prelandings and landings, disable the ability to save the page using Ctrl+S keys and also disable the browser's context menu. To do so just change **$disable_text_copy** to *true*.
### Replacing Prelanding
You can make the cloaker to open the landing page in a separate browser's tab and then redirect the tab with the prelanding to another url. After the user closes your landing page tabe (s)he'll see the tab with this url. Use it to show another offer to the user. To do so change **$replace_prelanding** to *true* and put your url into **$replace_prelanding_address**.
### Phone Masks
You can tell the cloaker to use masks for the phone field on your local landings. When you do so, the visitor won't be able to add any letters into the phone field, only numbers. The mask defines numbers count and delimeters. To enable masks just change **$black_land_use_phone_mask** to *true* and edit your mask in **$black_land_phone_mask**.
# Check Up
Add your own country to the cloaker's filters to be able to see the black page. Then go through all of the funnel's components. Send a test lead, verify that it reached your aff network.
# Running traffic and Statistics
After you started running traffic you can monitor it and also look at the statistics. To do so just go to a link like this:
`https://your.domain/logs?password=yourpassword`
where *yourpassword* is a value of **$log_password** from the settings.php file.

# Javascript Integration
You can connect this cloaker to any website or website-builder that allows adding Javascript. For example: *GitHub, Wix, Shopify* and so on.
When you do so you run traffic to the website-builder and after the visitor comes to this site a little script checks, if (s)he is allowed to view the blackpage. If (s)he is, then 2 things can happen:
- A redirect to your blackpage
- Website builder's content is replaced by the blackpage

## Redirect
Just add this script to your website builder:
`<script src="https://your.domain/js/indexr.php"></script>`

## Content replacing
Just add this script to your website builder:
`<script src="https://your.domain/js"></script>`
Don't use this method if you have only landings without prelandings!
# Technical Details
## Used components
This cloaker uses:
- MaxMind Databases for ISP, Country and City detection
- Bot IP Ranges from various sources collected all over from the Internet in CIDR format
- Sinergi BrowserDetector for (surprise!) browser detection
- IP Utils from Symphony for checking if the IP address is in a selected range

## Traffic flow
After the visitor passes the cloaker's filters he is usually shown the prelanding (if you have one). On the prelanding all links are being replaced by the link to the *landing.php* script. After the visitor clicks on the link, the *landing.php* script gets the landing's content, replaces action of all of the forms to *send.php*, adds all additional scripts and shows the content to the visitor. When the visitor fills the form and sends it *send.php* calls the original send script and then removes all of the redirects from it. After that *send.php* redirects to the *thankyou.php* which shows the thankyou page as described in the sections above.

<?php
require_once 'url.php';

function redirect($url,$redirect_type=302,$add_querystring=true){
    if ($add_querystring===true){
        $url=add_querystring($url);
    }
    if ($redirect_type===302) {
        header('Location: '.$url);
    } else {
        header('Location: '.$url, true, $redirect_type);
    }
}

function jsredirect($url){
    echo "<script type='text/javascript'> window.location='$url';</script>";
    return;
}
?>
<?php
require_once __DIR__.'/bases/ipcountry.php';
require_once __DIR__.'/url.php';
function get_prefix(){
    return (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off')  ? 'https://' : 'http://';
}

function get_port(){
    $curport = $_SERVER['SERVER_PORT'];
    if (isset($curport)&&$curport!=='80'&&$curport!=='443')
        return $curport;
	return (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off')  ? 443 : 80;
}

function get_domain_with_prefix(){
    $domain = $_SERVER['HTTP_HOST'];
    $prefix = get_prefix();
    return $prefix.$domain;
}

function get_abs_from_rel($url,$add_query_string=false){
    $domain = $_SERVER['HTTP_HOST'];
    $prefix = get_prefix();
    $fullpath= $prefix.$domain.'/'.$url;
    if (substr($url, -4) !== '.php') $fullpath=$fullpath.'/';
    if ($add_query_string===true)
    {
        $fullpath=add_querystring($fullpath);
    }
    return $fullpath;
}

function get_request_headers($ispost=false){
	$ip=getip();
    $headers=array(
				'X-YWBCLO-UIP: '.$ip,
				'X-FORWARDED-FOR '.$ip,
				//'CF-CONNECTING-IP: '.$ip,
				'FORWARDED-FOR: '.$ip,
				'X-COMING-FROM: '.$ip,
				'COMING-FROM: '.$ip,
				'FORWARDED-FOR-IP: '.$ip,
				'CLIENT-IP: '.$ip,
				'X-REAL-IP: '.$ip,
				'REMOTE-ADDR: '.$ip);
    if ($ispost)
        $headers[]="Content-Type: application/x-www-form-urlencoded";
    return $headers;
}

function get_html($url,$follow_location=false,$use_ua=false){
    $ispost=($_SERVER['REQUEST_METHOD']==='POST');

    $curl = curl_init();
    $optArray = array(
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
			CURLOPT_SSL_VERIFYPEER => false,
			CURLOPT_HTTPHEADER => get_request_headers($ispost)
			);
    if ($ispost){
        $optArray[CURLOPT_POST]=1;
        $optArray[CURLOPT_POSTFIELDS]=$_POST;
        $optArray[CURLOPT_FOLLOWLOCATION]=true;
    }

    if ($follow_location===true){
        $optArray[CURLOPT_FOLLOWLOCATION]=true ;
    }
    if ($use_ua===true){
        $optArray[CURLOPT_USERAGENT]='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML like Gecko) Chrome/84.0.4147.89 Safari/537.36';
    }
    curl_setopt_array($curl, $optArray);
    $html = curl_exec($curl);
    $info = curl_getinfo($curl);
    $error= curl_error($curl);
    curl_close($curl);
    return $html;
}

function get($url){
    $curl = curl_init();
    $optArray = array(
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
			CURLOPT_SSL_VERIFYPEER => false,
			CURLOPT_HTTPHEADER => get_request_headers(false),
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => false,
            CURLOPT_REFERER => $_SERVER['REQUEST_URI'],
            CURLOPT_USERAGENT=>'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML like Gecko) Chrome/84.0.4147.89 Safari/537.36'
			);
    curl_setopt_array($curl, $optArray);
    $content = curl_exec($curl);
    $info = curl_getinfo($curl);
    $error= curl_error($curl);
    curl_close($curl);
    return ["html"=>$content,"info"=>$info,"error"=>$error];
}

function post($url,$postfields){
    $curl = curl_init();
    curl_setopt_array($curl, array(
      CURLOPT_URL => $url,
      CURLOPT_RETURNTRANSFER => true,
      CURLOPT_TIMEOUT => 0,
      CURLOPT_FOLLOWLOCATION => false,
      CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
      CURLOPT_CUSTOMREQUEST => "POST",
      CURLOPT_SSL_VERIFYPEER => false,
      CURLOPT_POSTFIELDS => $postfields,
      CURLOPT_REFERER => $_SERVER['REQUEST_URI'],
      CURLOPT_HTTPHEADER => get_request_headers(true),
      CURLOPT_USERAGENT=>'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML like Gecko) Chrome/84.0.4147.89 Safari/537.36'
     ));

    $content = curl_exec($curl);
    $info = curl_getinfo($curl);
    $error= curl_error($curl);
    curl_close($curl);
    return ["html"=>$content,"info"=>$info,"error"=>$error];
}
?>
<?php
//Включение отладочной информации
ini_set('display_errors', '1');
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
//Конец включения отладочной информации

require_once 'settings.php';
require_once 'db.php';
require_once 'cookies.php';
require_once 'redirect.php';
require_once 'requestfunc.php';

$name = '';
if (isset($_POST['name']))
    $name=$_POST['name'];
else if (isset($_POST['fio']))
    $name=$_POST['fio'];
else if (isset($_POST['first_name'])&&isset($_POST['last_name']))
    $name = $_POST['first_name'].' '.$_POST['last_name'];
else if (isset($_POST['firstname'])&&isset($_POST['lastname']))
    $name = $_POST['firstname'].' '.$_POST['lastname'];

$phone='';
if (isset($_POST['phone']))
    $phone=$_POST['phone'];
else if (isset($_POST['tel']))
    $phone=$_POST['tel'];

$subid = get_subid();
if ($subid==='' && isset($_POST['subid']))
    $subid=$_POST['subid'];

//если юзверь каким-то чудом отправил пустые поля в форме
if ($name===''||$phone===''){
    redirect('thankyou.php?nopixel=1');
    return;
}

$date = new DateTime();
$ts = $date->getTimestamp();

$is_duplicate=has_conversion_cookies($name,$phone);
//устанавливаем пользователю в куки его имя и телефон, чтобы показать их на стр Спасибо
//также ставим куки даты конверсии
ywbsetcookie('name',$name,'/');
ywbsetcookie('phone',$phone,'/');
ywbsetcookie('ctime',$ts,'/');

//шлём в ПП только если это не дубль
if (!$is_duplicate){
    $fullpath='';
    //если у формы прописан в action адрес, а не локальный скрипт, то шлём все данные формы на этот адрес
    if (substr($black_land_conversion_script, 0, 4 ) === "http"){
        $fullpath=$black_land_conversion_script;
    }
    //иначе составляем полный адрес до скрипта отправки ПП
    else{
        $url= get_cookie('landing').'/'.$black_land_conversion_script;
        $fullpath = get_abs_from_rel($url);
    }

    //на всякий случай, перед отправкой чекаем, установлен ли subid
    $sub_rewrites=array_column($sub_ids,'rewrite','name');
    if (array_key_exists('subid',$sub_rewrites)){
        if (!isset($_POST[$sub_rewrites['subid']])||
            $_POST[$sub_rewrites['subid']]!==$subid)
            $_POST[$sub_rewrites['subid']]=$subid;
    }

    $res=post($fullpath,http_build_query($_POST));

    //в ответе должен быть редирект, если его нет - грузим обычную страницу Спасибо кло
    switch($res["info"]["http_code"]){
        case 302:
            add_lead($subid,$name,$phone);
            if ($black_land_use_custom_thankyou_page ){
                redirect("thankyou/thankyou.php?".http_build_query($_GET),302,false);
            }
            else{
                redirect($res["info"]["redirect_url"]);
            }
            break;
        case 200:
            add_lead($subid,$name,$phone);
            if ($black_land_use_custom_thankyou_page ){
                jsredirect("thankyou/thankyou.php?".http_build_query($_GET));
            }
            else{
                echo $res["html"];
            }
            break;
        default:
            var_dump($res["error"]);
            var_dump($res["info"]);
            exit();
            break;
    }
}
else
{
    redirect('thankyou/thankyou.php?nopixel=1');
}

?>
{
    "white": {
        "action": "folder",
        "folder": {
            "names": [
                "land"
            ]
        },
        "redirect": {
            "type": 303,
            "urls": [
                "https://ya.ru",
                "https://google.com"
            ]
        },
        "curl": {
            "urls": [
                "https://www.9111.ru/"
            ]
        },
        "error": {
            "codes": []
        },
        "domainfilter": {
            "use": false,
            "domains": [
                {
                    "name": "lalala.xxx.com",
                    "action": "site:white"
                },
                {
                    "name": "lamama.xxx.com",
                    "action": "site:white"
                }
            ]
        },
        "jschecks": {
            "enabled": false,
            "events": [
                "audiocontext",
                "timezone"
            ],
            "timeout": 40000,
            "obfuscate": true,
            "timezone": true,
            "tzstart": -3,
            "tzend": 4
        }
    },
    "black": {
        "prelanding": {
            "action": "none",
            "folders": [
                "preland"
            ],
            "redirect": {
                "urls": [
                    "https://ya.ru",
                    "https://google.com"
                ],
                "type": 302
            }
        },
        "landing": {
            "action": "folder",
            "folder": {
                "names": [
                    "land"
                ],
                "conversions": {
                    "script": "order.php",
                    "logonbuttonclick": false
                },
                "customthankyoupage": {
                    "use": true,
                    "language": "RU",
                    "upsell": {
                        "use": false,
                        "imgdir": "img",
                        "header": "This is a header!",
                        "text": "This is a text!",
                        "url": "http://ya.ru"
                    }
                }
            },
            "redirect": {
                "urls": [
                    "https://yandex.ru"
                ],
                "type": 303
            }
        },
        "jsconnect": "replace"
    },
    "pixels": {
        "ya": {
            "id": ""
        },
        "gtm": {
            "id": ""
        },
        "fb": {
            "subname": "px",
            "pageview": true,
            "viewcontent": {
                "use": false,
                "time": 30,
                "percent": 75
            },
            "conversion": {
                "event": "Lead",
                "fireonbutton": false
            }
        },
        "tt": {
            "subname": "tpx",
            "pageview": true,
            "viewcontent": {
                "use": true,
                "time": 30,
                "percent": 75
            },
            "conversion": {
                "event": "Purchase",
                "fireonbutton": false
            }
        }
    },
    "tds": {
        "mode": "on",
        "saveuserflow": false,
        "filters": {
            "allowed": {
                "countries": [
                    "UA",
                    "BY",
                    "RU"
                ],
                "os": [
                    "Android",
                    "iOS",
                    "Windows",
                    "OS X"
                ],
                "inurl": [],
                "languages": []
            },
            "blocked": {
                "ips": {
                    "filename": "",
                    "cidrformat": false
                },
                "tokens": [],
                "useragents": [
                    "facebook",
                    "Facebot",
                    "curl",
                    "gce-spider",
                    "yandex.com/bots",
                    "OdklBot"
                ],
                "isps": [
                    "facebook",
                    "google",
                    "yandex",
                    "amazon",
                    "azure",
                    "digitalocean",
                    "microsoft"
                ],
                "referer": {
                    "empty": false,
                    "stopwords": []
                },
                "vpntor": false
            }
        }
    },
    "scripts": {
        "back": {
            "action": "off",
            "value": "https://ya.ru"
        },
        "disabletextcopy": false,
        "prelandingreplace": {
            "use": false,
            "url": "https://ya.ru"
        },
        "landingreplace": {
            "use": false,
            "url": "https://ya.ru"
        },
        "phonemask": {
            "use": true,
            "mask": "+7(\\\\999)999-99-99"
        },
        "comebacker": false,
        "callbacker": false,
        "addedtocart": false,
        "imageslazyload": true
    },
    "subids": [
        {
            "name": "subid",
            "rewrite": "sub1"
        },
        {
            "name": "adn",
            "rewrite": "sub2"
        },
        {
            "name": "ad",
            "rewrite": "sub3"
        },
        {
            "name": "pl",
            "rewrite": "sub4"
        }
    ],
    "statistics": {
        "password": 12345,
        "subnames": [
            {
                "name": "adn",
                "value": "Adset"
            },
            {
                "name": "ad",
                "value": "Creative"
            },
            {
                "name": "pl",
                "value": "Placement"
            }
        ],
        "timezone": "Europe/Moscow"
    },
    "postback": {
        "lead": "Lead",
        "purchase": "Purchase",
        "reject": "Reject",
        "trash": "Trash",
        "s2s": [
            {
                "url": "",
                "method": "POST",
                "events": [
                    "Lead",
                    "Purchase"
                ]
            }
        ]
    }
}

<?php
use Noodlehaus\Config;
require_once 'config/ConfigInterface.php';
require_once 'config/AbstractConfig.php';
require_once 'config/Config.php';
require_once 'config/Parser/ParserInterface.php';
require_once 'config/Parser/Json.php';
require_once 'config/ErrorException.php';
require_once 'config/Exception.php';
require_once 'config/Exception/ParseException.php';
require_once 'config/Exception/FileNotFoundException.php';

$conf = Config::load(__DIR__.'/settings.json');

$white_action = $conf->get('white.action','folder');
$white_folder_names = $conf->get('white.folder.names',['white']);
$white_redirect_urls = $conf->get('white.redirect.urls',[]);
$white_redirect_type = $conf->get('white.redirect.type',302);
$white_curl_urls = $conf->get('white.curl.urls',[]);
$white_error_codes = $conf->get('white.error.codes',[404]);
$white_use_domain_specific=$conf->get('white.domainfilter.use',false);
$white_domain_specific= $conf['white.domainfilter.domains'];

$use_js_checks = $conf['white.jschecks.enabled'];
$js_checks = $conf['white.jschecks.events'];
$js_timeout =$conf['white.jschecks.timeout'];
$js_obfuscate = $conf['white.jschecks.obfuscate'];
$js_tzstart = $conf['white.jschecks.tzstart'];
$js_tzend = $conf['white.jschecks.tzend'];

$black_preland_action = $conf['black.prelanding.action'];
$black_preland_folder_names = $conf['black.prelanding.folders'];

$black_land_action = $conf['black.landing.action'];
$black_land_folder_names = $conf['black.landing.folder.names'];
$black_land_redirect_urls = $conf['black.landing.redirect.urls'];
$black_land_redirect_type = $conf['black.landing.redirect.type'];
$black_land_conversion_script = $conf['black.landing.folder.conversions.script'];
$black_land_log_conversions_on_button_click = $conf['black.landing.folder.conversions.logonbuttonclick'];
$black_land_use_custom_thankyou_page = $conf['black.landing.folder.customthankyoupage.use'];
if ($black_land_use_custom_thankyou_page) $black_land_log_conversions_on_button_click=false;
$black_land_thankyou_page_language = $conf['black.landing.folder.customthankyoupage.language'];

$thankyou_upsell=$conf['black.landing.folder.customthankyoupage.upsell.use'];
$thankyou_upsell_imgdir = $conf['black.landing.folder.customthankyoupage.upsell.imgdir'];
$thankyou_upsell_header = $conf['black.landing.folder.customthankyoupage.upsell.header'];
$thankyou_upsell_text = $conf['black.landing.folder.customthankyoupage.upsell.text'];
$thankyou_upsell_url = $conf['black.landing.folder.customthankyoupage.upsell.url'];

$black_jsconnect_action=$conf['black.jsconnect'];

$ya_id= $conf['pixels.ya.id'];
$gtm_id= $conf['pixels.gtm.id'];
$fbpixel_subname = $conf['pixels.fb.subname'];
$fb_use_pageview = $conf['pixels.fb.pageview'];
$fb_use_viewcontent = $conf['pixels.fb.viewcontent.use'];
$fb_view_content_time = $conf['pixels.fb.viewcontent.time'];
$fb_view_content_percent = $conf['pixels.fb.viewcontent.percent'];
$fb_thankyou_event = $conf['pixels.fb.conversion.event'];
$fb_add_button_pixel= $conf['pixels.fb.conversion.fireonbutton'];
$ttpixel_subname = $conf['pixels.tt.subname'];
$tt_use_pageview = $conf['pixels.tt.pageview'];
$tt_use_viewcontent = $conf['pixels.tt.viewcontent.use'];
$tt_view_content_time = $conf['pixels.tt.viewcontent.time'];
$tt_view_content_percent = $conf['pixels.tt.viewcontent.percent'];
$tt_thankyou_event = $conf['pixels.tt.conversion.event'];
$tt_add_button_pixel= $conf['pixels.tt.conversion.fireonbutton'];

$tds_mode = $conf['tds.mode'];
$save_user_flow = $conf['tds.saveuserflow'];

$os_white = $conf['tds.filters.allowed.os'];
$country_white = $conf['tds.filters.allowed.countries'];
$url_should_contain =$conf['tds.filters.allowed.inurl'];
$lang_white = $conf['tds.filters.allowed.languages'];

$ip_black_filename = $conf->get('tds.filters.blocked.ips.filename','');
$ip_black_cidr = $conf->get('tds.filters.blocked.ips.cidrformat',false);
$tokens_black = $conf['tds.filters.blocked.tokens'];
$ua_black = $conf['tds.filters.blocked.useragents'];
$isp_black = $conf['tds.filters.blocked.isps'];
$block_without_referer = $conf['tds.filters.blocked.referer.empty'];
$referer_stopwords = $conf['tds.filters.blocked.referer.stopwords'];
$block_vpnandtor = $conf['tds.filters.blocked.vpntor'];

$back_button_action = $conf['scripts.back.action'];
$replace_back_address = $conf['scripts.back.value'];
$disable_text_copy = $conf['scripts.disabletextcopy'];
$replace_prelanding = $conf['scripts.prelandingreplace.use'];
$replace_prelanding_address = $conf['scripts.prelandingreplace.url'];
$replace_landing = $conf['scripts.landingreplace.use'];
$replace_landing_address = $conf['scripts.landingreplace.url'];
$black_land_use_phone_mask = $conf['scripts.phonemask.use'];
$black_land_phone_mask = $conf['scripts.phonemask.mask'];
$comebacker = $conf['scripts.comebacker'];
$callbacker = $conf['scripts.callbacker'];
$addedtocart = $conf['scripts.addedtocart'];
$images_lazy_load = $conf['scripts.imageslazyload'];

$sub_ids = $conf['subids'];

$log_password = strval($conf['statistics.password']);
$stats_timezone = $conf->get('statistics.timezone','Europe/Moscow');
$stats_sub_names = $conf['statistics.subnames'];

$s2s_postbacks = $conf['postback.s2s'];

$lead_status_name = $conf['postback.lead'];
$purchase_status_name = $conf['postback.purchase'];
$reject_status_name = $conf['postback.reject'];
$trash_status_name = $conf['postback.trash'];

?>
<?php
require_once __DIR__.'/settings.php';
require_once __DIR__.'/cookies.php';
require_once __DIR__.'/pixels.php';

//заменяем все макросы на реальные значения из куки
function replace_all_macros($url)
{
    global $fbpixel_subname;
    $px = get_fbpixel();
    $landing = get_cookie('landing');
    $prelanding = get_cookie('prelanding');
    $subid = get_subid();

    $tmp_url = str_replace('{px}', $px, $url);
    $tmp_url = str_replace('{landing}', $landing, $tmp_url);
    $tmp_url = str_replace('{prelanding}', $prelanding, $tmp_url);
    $tmp_url = str_replace('{subid}', $subid, $tmp_url);
    $tmp_url = str_replace('{domain}', $_SERVER['SERVER_NAME'], $tmp_url);
    return $tmp_url;
}

function add_querystring($url)
{
    $delimiter= (strpos($url, '?')===false?"?":"&");
    $querystr = $_SERVER['QUERY_STRING'];
    if (!empty($querystr)) {
        $url = $url.$delimiter.$querystr;
    }
    return $url;
}

function add_subs_to_link($url)
{
    global $sub_ids;
    $preset=['subid','prelanding','landing'];
    foreach ($sub_ids as $sub) {
    	$key = $sub["name"];
        $value = $sub["rewrite"];
        $delimiter= (strpos($url, '?')===false?"?":"&");
        if (in_array($key,$preset)&& isset($_COOKIE[$key])) {
            $url.= $delimiter.$value.'='.$_COOKIE[$key];
        } elseif (!empty($_GET[$key])) {
            $url.= $delimiter.$value.'='.$_GET[$key];
        }
    }
    return $url;
}
?>

<?php
require_once 'redirect.php';
//чисто для формы на вайте, чтобы был один и тот же thankyou для вайта и блэка
redirect("thankyou/thankyou.php");
?>
